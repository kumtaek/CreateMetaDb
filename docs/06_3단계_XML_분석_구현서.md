# 06단계: XML 분석 구현서

## 1. 개요

본 문서는 소스 코드에서 MyBatis XML 매퍼 파일을 분석하여 SQL 구문을 추출하고, 그 구조를 해석하는 XML 분석기의 상세 구현 내용을 기술한다. 현재 XML 분석기는 **안정성, 확장성, 분석 커버리지**를 모두 확보하기 위해 이중 파서(Dual-Parser) 아키텍처를 채택하고 있다.

---

## 2. XML 분석기 아키텍처

XML 분석기는 다음과 같은 이중 파서 구조로 동작한다.

1.  **`EnhancedMybatisParser` (주 파서)**: `<include>` 태그 해석, 동적 SQL 분석 등 새롭고 복잡한 기능을 담당한다. 새로운 분석 로직은 이 파서에 우선적으로 구현된다.
2.  **`MybatisParser` (기본 파서/Fallback)**: `EnhancedMybatisParser`가 실패할 경우를 대비한 안정적인 대체 파서이다. 단순하고 검증된 로직으로 구성되어 있으며, 재귀 호출 등 잠재적인 오류 요소를 제거하여 어떤 경우에도 시스템이 중단되지 않도록 보장한다.

---

## 3. 처리 흐름 (Flow)

```mermaid
graph TD
    A[XML 파일 분석 시작] --> B{1. `EnhancedMybatisParser`로 파싱 시도};
    B -- 성공 --> C[분석 결과 반환 및 종료];
    B -- 실패 --> D{2. `MybatisParser`(기본 파서)로 대체 실행};
    D --> E[경고 로그 기록<br/>(실패 원인 및 대체 실행 알림)];
    E --> C;
```

1.  분석기는 우선 `EnhancedMybatisParser`를 사용하여 XML 파일의 DOM(Document Object Model)을 생성하고 파싱을 시도한다.
2.  **성공 시**: `EnhancedMybatisParser`가 성공적으로 SQL 구문을 추출하고 분석하면, 해당 결과를 즉시 반환하고 작업을 종료한다.
3.  **실패 시**: `EnhancedMybatisParser`가 복잡한 구조나 예외적인 문법 등으로 인해 오류를 발생시키면, 시스템은 중단되지 않는다. 대신, 실패 사실과 원인을 로그로 기록하고, 사전에 정의된 안정적인 `MybatisParser`로 작업을 자동 전환(Fallback)한다.
4.  `MybatisParser`는 안정성에 초점을 맞춰 개발되었으므로, 어떤 복잡한 파일이라도 최소한의 분석을 보장하며 작업을 완료한다.

이러한 구조를 통해, 새로운 분석 기능을 계속해서 시도하면서도 예외적인 상황에서는 안정성을 확보하는 유연한 시스템을 구축했다.

---

## 4. 핵심 기능 상세

### 4.1. `<include>` 태그 해석
- **담당 파서**: `EnhancedMybatisParser`
- **동작**: 다른 XML 파일에 정의된 `<sql>` 조각을 참조하는 `<include>` 태그를 해석한다. 사전에 캐싱된 `<sql>` 조각을 가져와 원본 SQL 구문에 삽입하여, 완전한 형태의 SQL을 재구성한 후 분석을 진행한다.
- **효과**: 공통 SQL 구문의 누락을 방지하여 분석 커버리지를 높인다.

### 4.2. 동적 SQL 분석 (제한적)
- **담당 파서**: `EnhancedMybatisParser`
- **동작**: `<if>`, `<foreach>`, `<choose>` 등 동적 SQL 태그를 만나면, 모든 경우의 수를 분석하는 대신 **대표적인 경로(Representative Path)**를 선택하여 시뮬레이션한다. 이는 분석의 정확성과 시스템 성능(조합 폭발 방지) 사이의 균형을 맞추기 위함이다.
- **효과**: 동적 SQL 내에 숨겨진 테이블/컬럼 정보를 일부라도 추출하여 분석 정확도를 높인다.

### 4.3. 안정성 보장 (비재귀 파싱)
- **담당 파서**: `MybatisParser` (기본 파서)
- **동작**: 과거 재귀 호출 방식으로 인해 메모리 초과 및 시스템 중단 오류를 유발했던 텍스트 추출 로직을, **안전한 이터레이터(iterator) 방식**으로 전면 교체했다.
- **효과**: 아무리 깊고 복잡하게 중첩된 XML 구조라도 재귀 깊이 제한 없이 안정적으로 분석을 완료한다. **시스템이 절대 멈추지 않는 것을 보장**하는 핵심적인 안정성 장치이다.

### 4.4. 효율적인 단일 파싱 (Single-Pass)
- **동작**: 과거에는 하나의 파일을 처리하면서 내부적으로 불필요한 재파싱을 반복하는 구조적 결함이 있었다. 현재는 이 로직을 수정하여, 어떤 파일이든 **단 한 번의 파싱**으로 모든 분석이 완료되도록 최적화했다.
- **효과**: 불필요한 경고 로그 발생을 없애고, 전체 분석 시간 단축 및 시스템 효율성을 향상시켰다.
