# 처리플로우 상세 - 3단계: XML 분석 구현서

## 1. 개요

본 문서는 MyBatis XML 매퍼 파일을 분석하여 SQL 구문을 추출하고 **연관관계 도출**에 필요한 정보를 수집하는 XML 분석기의 구현 내용을 기술한다. **3단계 쿼리 분석기 개선 완료** 이후 MyBatis 동적 태그 제거하여 순수 SQL 추출하고, 공통 SQL 파서로 일관된 고품질 분석을 수행한다.

**개선 완료 현황**: 메소드-쿼리-테이블-조인조건 도출 완료, 3단계 쿼리 분석 프로세스 완전 구현

---

## 2. 3단계 쿼리 분석기 구현 완료 (XML 파서 적용)

### 2.1 1단계 - XML 쿼리 추출 및 저장
- **XML 태그 제거**: MyBatis 동적 태그(`<if>`, `<choose>`, `<when>`, `<otherwise>`) 제거
- **바인딩 변수 처리**: `#{param}`, `${param}` 형태 처리
- **순수 SQL 추출**: XML 문법 제거 후 순수 쿼리만 추출
- **SqlContent.db 저장**: components와 sqlcontent(압축)에 등록
- **공통 2,3단계 처리**: 추출된 쿼리에 대해 공통 테이블 추출 및 조인 분석

### 2.2 2단계 - 테이블 추출 (공통 처리)
- **설계된 SQL 패턴 적용**: FROM, UPDATE, DELETE, INSERT, MERGE, JOIN 패턴에서 테이블 추출
- **알리아스 처리**: 테이블과 알리아스를 딕셔너리 변수로 저장
- **INFERRED 테이블 등록**: 존재하지 않는 테이블은 INFERRED로 등록 (table_owner = 'UNKNOWN')
- **오라클 키워드 필터링**: config 폴더의 오라클 키워드 파일 참조하여 키워드 제외

### 2.3 3단계 - 조인관계 추출 (공통 처리)
- **EXPLICIT JOIN**: `JOIN ... ON <조인조건>` 패턴 분석
- **IMPLICIT JOIN**: `WHERE ... <조인조건>` 패턴 분석
- **테이블 알리아스 참조**: 2단계에서 넘겨받은 딕셔너리 변수 활용
- **이퀄 조건 필터링**: `테이블1.컬럼1 = 테이블2.컬럼2` 형태만 조인조건으로 인식
- **INFERRED 컬럼 등록**: 존재하지 않는 컬럼은 INFERRED 컬럼으로 등록

## 3. XML 분석기 아키텍처 (3단계 쿼리 분석기 완료 버전)

**핵심 철학**: 1단계 쿼리 추출 → 2단계 테이블 추출 → 3단계 조인관계 추출로 **완전한 연결고리 구축**

### 개선된 파서 구조

1.  **쿼리 도려내기**: MyBatis 동적 태그 제거하여 순수 SQL 추출
   - `<if>`, `<where>`, `<choose>`, `<foreach>` 태그 제거
   - `#{param}`, `${param}` 바인딩 변수 제거
   - Java 문법 제거 및 공백 정리

2.  **공통부 활용**: SqlParser + SqlJoinAnalyzer로 일관된 분석
   - 쿼리 종류 인식 (INSERT/UPDATE/DELETE/MERGE/SELECT)
   - 에센스패턴 테이블 추출 (누락 방지)
   - EXPLICIT/IMPLICIT JOIN 관계 분석
   - 인퍼드 테이블 자동 등록

3.  **안정성 확보**: DOM → SAX → 정규식 순차 Fallback

---

## 3. 처리 흐름 (Flow)

### 📋 **XML 파싱 처리 흐름**

| 단계 | 처리 방식 | 결과 | 상태 | 비고 |
|------|-----------|------|------|------|
| **시작** | XML 파일 분석 시작 | 파일 준비 | 🚀 | MyBatis XML 대상 |
| **주 파싱** | MybatisParser 안정적 파싱 실행 | 성공/실패 판단 | ✅ | DOM 기반 파싱 |
| **성공 시** | SQL 컴포넌트 생성, JOIN 관계 분석 | 완전한 분석 결과 | ✅ | 표준 처리 경로 |
| **실패 시** | SAX Fallback 파서로 대체 | 기본 SQL 추출, 최소한의 분석 | ⚠️ | 안전망 역할 |
| **완료** | 분석 결과 반환 | 메타데이터 생성 | 🎯 | 최종 결과 |
| **참고** | EnhancedMybatisParser | 현재 비활성화 | ❌ | 복잡도 문제로 제거 |

1.  **MybatisParser**: 안정적인 DOM 기반 XML 파싱으로 SQL 구문과 JOIN 관계를 추출한다.
2.  **연관관계 중심**: 복잡한 동적 SQL 분석 대신 테이블 사용 관계와 JOIN 관계 도출에 집중한다.
3.  **SAX Fallback**: DOM 파싱 실패 시 SAX 파서로 자동 전환하여 최소한의 SQL 추출을 보장한다.
4.  **안정성 우선**: 파싱 실패보다는 연관관계 누락 방지를 우선으로 설계되었다.

연관관계 도출에 최적화된 안정적이고 효율적인 XML 분석 시스템입니다.

---

## 4. 핵심 기능 상세

### 4.1. 연관관계 중심 SQL 추출

- **담당 파서**: `MybatisParser` (주 파서)
- **동작**: MyBatis XML에서 연관관계 구축에 필요한 핵심 정보만 추출
  - SQL 구문 식별 (SELECT, INSERT, UPDATE, DELETE)
  - 테이블명 추출 (FROM, JOIN, UPDATE, INSERT INTO)
  - 조인 관계 분석 (INNER JOIN, LEFT JOIN 등)
- **효과**: 복잡한 동적 SQL 분석을 포기하고 연관관계 도출에 집중하여 안정성 확보

### 4.2. 단순화된 JOIN 관계 분석

- **담당 파서**: `SqlJoinAnalyzer` (공통 모듈)
- **동작**: 추출된 SQL에서 테이블 간 JOIN 관계만 단순 분석
  - 명시적 JOIN (INNER JOIN, LEFT JOIN 등)
  - 암시적 JOIN (WHERE 조건의 테이블 연결)
- **효과**: 테이블 간 연관관계 파악으로 ERD 생성 지원

### 4.3. 안정성 우선 설계

- **기본 원칙**: 파싱 실패보다는 **연관관계 누락 방지**가 우선
- **Fallback 전략**: DOM → SAX → 정규식 순서로 단계적 Fallback
- **에러 처리**: 파싱 실패 시 has_error='Y' 처리 후 계속 진행
- **효과**: 어떤 XML 파일이라도 최소한의 연관관계 정보는 추출 보장
