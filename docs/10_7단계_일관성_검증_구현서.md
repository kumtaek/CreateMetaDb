# 처리플로우 상세 - 7단계: 메타데이터베이스 일관성 검증

## 개요

**목적**: 메타데이터베이스 생성 완료 후 데이터 일관성 검증 및 오류 검출  
**핵심 기능**: 치명적 비일관성 검출 시 프로그램 종료, 경고성 문제는 로그만 출력  
**실행 함수**: `execute_consistency_validation()`  
**구현 상태**: ✅ **구현 완료**  
**파일**: `consistency_validator.py`  
**통합 위치**: `main.py` 7단계로 추가  
**실행 순서**: 1-6단계 완료 후 마지막에 실행

## 검증 대상

### 치명적 비일관성 (ERROR + EXIT)

#### 1. 외래키 무결성 위반
```sql
-- FOREIGN KEY 제약조건 실제 위반
files.project_id → projects.project_id (존재하지 않는 프로젝트 참조)
components.file_id → files.file_id (존재하지 않는 파일 참조)
relationships.src_id/dst_id → components.component_id (존재하지 않는 컴포넌트 참조)
classes.parent_class_id → classes.class_id (존재하지 않는 부모 클래스 참조)
```

#### 2. UNIQUE 제약조건 우회
```sql
-- ix_files_01 위반: (file_name, file_path, project_id)
같은 파일이 다른 file_id로 중복 등록
```

#### 3. API_URL 중복
```sql
-- 같은 API가 여러 파일에서 생성 (프론트엔드-백엔드 연결 끊어짐 원인)
component_name = '/api/users:GET'
file_id = 15 (ProxyController.java)
file_id = 19 (VersionedController.java)
```

#### 4. parent_id 타입 불일치
```sql
-- METHOD의 parent_id는 classes.class_id여야 함
component_type = 'METHOD', parent_id → 존재하지 않는 클래스 참조

-- COLUMN의 parent_id는 TABLE 컴포넌트여야 함  
component_type = 'COLUMN', parent_id → TABLE 타입이 아닌 컴포넌트 참조
```

#### 5. TABLE/COLUMN file_id 불일치
```sql
-- TABLE 컴포넌트는 ALL_TABLES.csv file_id여야 함
component_type = 'TABLE', file_id ≠ ALL_TABLES.csv의 file_id

-- COLUMN 컴포넌트는 ALL_TAB_COLUMNS.csv file_id여야 함
component_type = 'COLUMN', file_id ≠ ALL_TAB_COLUMNS.csv의 file_id
```

#### 6. CHECK 제약조건 위반
```sql
-- 자기 자신 참조 (CHECK (src_id != dst_id) 위반)
relationships.src_id = relationships.dst_id
```

### 경고성 케이스 (WARNING 로그만)

#### 정상적이지만 확인 필요한 케이스들:
```sql
-- 하나의 API가 여러 메서드와 연결 (버전 관리)
/api/users:GET → getUsers, getUsersV1, getUsersV2

-- 백엔드 연결 없는 API (JPA 자동 생성)
JpaApiService.js의 /api/users:GET

-- SQL 없는 DAO 메서드 (계산 전용)
calculateTotalAmount() -- DB 접근 없이 계산만

-- 테이블 연결 없는 SQL (시스템 함수)
SELECT SYSDATE FROM DUAL

-- 같은 쿼리명 중복 (여러 Mapper에서 같은 이름 - 정상)
selectUser in UserMapper.xml, UserMapper_v2.xml
```

## 구현 상세

### 검증 클래스 구조

```python
class ConsistencyValidator:
    def __init__(self, project_name: str):
        # CSV 파일 ID 동적 조회
        self.all_tables_file_id = self._get_csv_file_id('ALL_TABLES.csv')
        self.all_columns_file_id = self._get_csv_file_id('ALL_TAB_COLUMNS.csv')
    
    def validate_all(self) -> bool:
        # 치명적 비일관성 검사
        self._check_foreign_key_violations()
        self._check_file_duplicates()
        self._check_api_url_duplicates()
        self._check_relationship_violations()
        self._check_parent_id_violations()
        self._check_table_column_file_id_violations()
        
        # 경고성 검사
        self._check_warning_cases()
        
        # 치명적 문제 발견 시 handle_error() 호출하여 EXIT
        if self.critical_violations:
            handle_error(Exception("일관성 위반"), "치명적 일관성 문제")
            return False
        
        return True
```

### main.py 통합

```python
# 7. 메타데이터베이스 일관성 검증 (신규 추가)
info("\n\n\n\n7단계 시작 ========================================")
info("7단계 실행: 메타데이터베이스 일관성 검증")

from consistency_validator import execute_consistency_validation

validation_success = execute_consistency_validation(project_name)
if not validation_success:
    # 치명적 문제 발견 시 프로그램 종료됨
    handle_error(Exception("일관성 검증 실패"), "7단계 실패: 일관성 검증")
```

## 검증 결과 처리

### 성공 시
- 모든 단계 정상 완료
- 리포트 생성 가능

### 실패 시  
- ERROR 로그 출력
- handle_error() 호출로 프로그램 종료
- 문제 수정 후 재실행 필요

이 검증기를 통해 메타데이터베이스의 품질과 신뢰성을 보장합니다.