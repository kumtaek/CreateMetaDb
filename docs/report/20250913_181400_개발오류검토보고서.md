# 개발 오류 검토 보고서

**작성일**: 2025-09-13
**검토 대상**: EXPLICIT & IMPLICIT JOIN 분석 로직 통합 개발 후에도 개선되지 않는 문제
**핵심 문제 파일**: `docs/report/20250113_180800_정답지3_비교대사_보고서.md`

---

## 1. 문제 현상

JOIN 분석 로직 개선에도 불구하고, `정답지3` 기준의 메타데이터 생성 목표치에 도달하지 못하는 문제가 지속되고 있습니다. 핵심적으로 `sql_content`, `relationships`, `inferred tables` 관련 데이터 생성이 대부분 누락됩니다.

## 2. 근본 원인 분석

### 2.1. 분리된 데이터베이스 설계의 구조적 결함

- 시스템은 **메인 메타데이터 DB**와 **SQL 쿼리 저장용 `SqlContent.db`** 라는 2개의 데이터베이스를 사용하도록 의도되었습니다.
- `database/create_table_script.sql`은 메인 DB를, `database/create_sql_content_db.sql`은 `SqlContent.db`의 스키마를 각각 정의합니다.

### 2.2. 메인 실행 로직의 `SqlContent.db` 처리 누락

- **결정적 증거**: `main.py`의 전체 실행 흐름을 분석한 결과, 메인 DB를 생성하고 사용하는 로직만 존재하며, **`SqlContent.db`를 생성, 연결, 사용하는 코드는 전무합니다.**
- **결론**: 이로 인해 `sql_contents` 테이블이 물리적으로 생성되지 않아, XML에서 파싱된 SQL 쿼리 데이터가 저장될 곳이 없어 모두 유실됩니다. 데이터가 없으니 새로 개발된 JOIN 분석 로직 또한 실행될 수 없습니다.

> **핵심 요약: JOIN 분석 로직의 문제가 아니라, 분리된 DB 설계와 이를 처리하지 못하는 메인 로직의 부재로 인해 발생한 데이터 유실이 근본 원인입니다.**

---

## 3. 해결 방안

비효율적이고 오류 발생 가능성이 높은 2-DB 구조를 폐기하고, 단일 데이터베이스로 스키마를 통합하는 것이 가장 안정적이고 올바른 해결책입니다.

### 3.1. 1단계: 데이터베이스 스키마 통합 (즉시 필요)

- `create_sql_content_db.sql`에 정의된 `sql_contents` 테이블 스키마를 메인 스키마 파일인 `create_table_script.sql`로 통합합니다.
- 통합 시, 분리된 DB에서는 불가능했던 **테이블 간의 정식 외래 키(Foreign Key) 관계를 설정**하여 데이터 무결성을 강화합니다.

**통합될 `sql_contents` 스키마 (예시):**
```sql
CREATE TABLE IF NOT EXISTS sql_contents (
    content_id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    file_id INTEGER NOT NULL,
    component_id INTEGER NOT NULL,
    query_type VARCHAR(20) NOT NULL,
    sql_content_compressed BLOB NOT NULL,
    hash_value VARCHAR(64) NOT NULL,
    created_at DATETIME DEFAULT (datetime('now', '+9 hours')),
    updated_at DATETIME DEFAULT (datetime('now', '+9 hours')),
    del_yn CHAR(1) DEFAULT 'N',
    FOREIGN KEY (project_id) REFERENCES projects(project_id),
    FOREIGN KEY (file_id) REFERENCES files(file_id),
    FOREIGN KEY (component_id) REFERENCES components(component_id)
);
CREATE UNIQUE INDEX ix_sql_contents_01 ON sql_contents (component_id);
CREATE INDEX ix_sql_contents_02 ON sql_contents (hash_value);
```

### 3.2. 2단계: 데이터 저장 로직 수정 (예상)

스키마 통합 후, `xml_loading.py` 등에서 SQL 쿼리 파싱 후 `sql_contents` 테이블에 `INSERT`하는 로직이 단일 DB 연결을 통해 정상적으로 동작하는지 확인하고, 필요시 수정합니다.

---

## 4. 다음 조치

상기 해결 방안에 따라, **`create_table_script.sql` 파일에 `sql_contents` 테이블 생성 구문을 추가하여 스키마를 통합**하는 작업을 진행하겠습니다.
