# 5단계 개발계획서 - JSP 컴포넌트 추출 로직

## 문서 정보
- **작성일**: 2025-09-14 02:28:00
- **작성자**: AI Assistant
- **문서 유형**: 개발계획서
- **대상 단계**: 5단계 - JSP 컴포넌트 추출

## 1. JSP 컴포넌트 추출 개요

### 1.1 추출 대상
- **JSP 파일**: `.jsp` 확장자를 가진 모든 파일
- **컴포넌트 정보**: JSP 파일명, 경로, 라인 번호, 해시값
- **관계 정보**: JSP → Java 메서드 호출 관계

### 1.2 추출 과정
1. **JSP 파일 수집**: 프로젝트 내 모든 JSP 파일 수집
2. **JSP 컴포넌트 정보 추출**: 파일명, 경로, 라인 번호, 해시값 추출
3. **Java 메서드 호출 분석**: JSP 내 Java 메서드 호출 패턴 분석
4. **관계 정보 생성**: JSP → METHOD 관계 정보 생성

## 2. JSP 파일 수집 및 필터링

### 2.1 JSP 파일 수집 로직

```python
def get_filtered_jsp_files(self, project_path: str = None) -> List[str]:
    """
    JSP 파일 수집 및 필터링
    
    Args:
        project_path: 프로젝트 경로
        
    Returns:
        JSP 파일 경로 리스트
    """
    try:
        # USER RULES: 공통함수 사용 지향
        file_utils = FileUtils()
        
        # USER RULES: 하드코딩 지양 - PathUtils 공통함수 사용
        if project_path is None and self.project_name:
            from util import PathUtils
            path_utils = PathUtils()
            project_path = path_utils.get_project_source_path(self.project_name)
        
        if not project_path:
            # USER RULES: Exception 발생시 handle_error()로 exit()
            handle_error(Exception("프로젝트 경로가 지정되지 않았습니다"), "JSP 파일 수집 실패")
        
        jsp_files = []
        for root, dirs, files in os.walk(project_path):
            for file in files:
                if file.endswith('.jsp'):
                    file_path = os.path.join(root, file)
                    if self._is_valid_jsp_file(file_path):
                        jsp_files.append(file_path)
        
        info(f"JSP 파일 수집 완료: {len(jsp_files)}개")
        return jsp_files
        
    except Exception as e:
        # USER RULES: Exception 발생시 handle_error()로 exit()
        handle_error(e, "JSP 파일 수집 실패")
        return []
```

### 2.2 JSP 파일 유효성 검증

```python
def _is_valid_jsp_file(self, file_path: str) -> bool:
    """
    유효한 JSP 파일인지 확인
    
    Args:
        file_path: 파일 경로
        
    Returns:
        유효성 여부
    """
    try:
        file_utils = FileUtils()
        content = file_utils.read_file(file_path)
        if not content:
            return False
        
        # 기본적인 JSP 파일 검증
        jsp_indicators = [
            '<%@',  # JSP 지시어
            '<%',   # 스크립틀릿
            '<%=',  # 표현식
            '<jsp:', # JSP 액션
            '<c:',  # JSTL Core
            '<fmt:', # JSTL Formatting
            '<sql:', # JSTL SQL
            '<x:'   # JSTL XML
        ]
        
        content_lower = content.lower()
        return any(indicator in content_lower for indicator in jsp_indicators)
        
    except Exception as e:
        warning(f"JSP 파일 확인 실패: {file_path}, 오류: {str(e)}")
        return False
```

### 2.3 JSP 파일 필터링 규칙

**포함 대상**:
- `.jsp` 확장자 파일
- JSP 지시어, 스크립틀릿, 표현식, 액션 태그 포함
- JSTL 태그 포함

**제외 대상**:
- 빈 파일
- JSP 지시어나 태그가 없는 파일
- 읽기 권한이 없는 파일

## 3. JSP 컴포넌트 정보 추출

### 3.1 JSP 컴포넌트 정보 추출 로직

```python
def _extract_jsp_component_info(self, jsp_content: str, file_path: str) -> Dict[str, Any]:
    """
    JSP 파일에서 JSP 컴포넌트 정보 추출
    
    Args:
        jsp_content: JSP 파일 내용
        file_path: 파일 경로
        
    Returns:
        JSP 컴포넌트 정보
    """
    try:
        # JSP 파일명 추출
        jsp_name = os.path.basename(file_path)
        
        # JSP 경로 추출 (웹 애플리케이션 기준 상대 경로)
        jsp_path = self._extract_jsp_path(file_path)
        
        # 라인 번호 추출
        line_start = 1
        line_end = jsp_content.count('\n') + 1
        
        # 해시 값 생성
        hash_value = HashUtils().generate_md5(jsp_content)
        
        return {
            'jsp_name': jsp_name,
            'jsp_path': jsp_path,
            'line_start': line_start,
            'line_end': line_end,
            'hash_value': hash_value
        }
        
    except Exception as e:
        # USER RULES: 파싱 에러는 has_error='Y', error_message 남기고 계속 진행
        warning(f"JSP 컴포넌트 정보 추출 실패: {str(e)}")
        return None
```

### 3.2 JSP 경로 추출

```python
def _extract_jsp_path(self, file_path: str) -> str:
    """
    JSP 파일 경로에서 웹 애플리케이션 기준 상대 경로 추출
    
    Args:
        file_path: JSP 파일 경로
        
    Returns:
        웹 애플리케이션 기준 상대 경로
    """
    try:
        # 프로젝트 소스 경로에서 상대 경로 추출
        if self.project_name:
            from util import PathUtils
            path_utils = PathUtils()
            project_source_path = path_utils.get_project_source_path(self.project_name)
            
            if file_path.startswith(project_source_path):
                relative_path = os.path.relpath(file_path, project_source_path)
                # Windows 경로를 Unix 경로로 변환
                return '/' + relative_path.replace('\\', '/')
        
        # 기본값: 파일명만 반환
        return '/' + os.path.basename(file_path)
        
    except Exception as e:
        warning(f"JSP 경로 추출 실패: {str(e)}")
        return '/' + os.path.basename(file_path)
```

### 3.3 JSP 컴포넌트 정보 구성

**JSP 컴포넌트 정보**:
- `jsp_name`: JSP 파일명 (예: "userList.jsp")
- `jsp_path`: 웹 애플리케이션 기준 상대 경로 (예: "/WEB-INF/views/user/userList.jsp")
- `line_start`: 시작 라인 번호 (항상 1)
- `line_end`: 종료 라인 번호 (파일의 마지막 라인)
- `hash_value`: JSP 내용 해시값 (MD5)

## 4. JSP 컴포넌트 데이터베이스 저장

### 4.1 JSP 컴포넌트 저장 로직

```python
def _save_jsp_components_to_database(self, jsp_components: List[Dict[str, Any]]) -> bool:
    """
    JSP 컴포넌트를 components 테이블에 저장
    
    Args:
        jsp_components: JSP 컴포넌트 정보 리스트
        
    Returns:
        저장 성공 여부
    """
    try:
        if not jsp_components:
            warning("저장할 JSP 컴포넌트가 없습니다")
            return True
        
        # 프로젝트 ID 조회 (USER RULES: 공통함수 사용)
        project_id = self._get_project_id()
        if not project_id:
            handle_error(Exception("프로젝트 ID를 찾을 수 없습니다"), "JSP 컴포넌트 저장 실패")
            return False
        
        # JSP 데이터 변환
        jsp_data_list = []
        for jsp_info in jsp_components:
            # 파일 ID 조회
            file_id = self._get_file_id(jsp_info['file_path'])
            if not file_id:
                warning(f"파일 ID를 찾을 수 없습니다: {jsp_info['file_path']}")
                continue
            
            jsp_data = {
                'project_id': project_id,
                'component_type': 'JSP',
                'component_name': jsp_info['jsp_name'],
                'parent_id': None,  # JSP는 독립적인 컴포넌트
                'file_id': file_id,
                'line_start': jsp_info['line_start'],
                'line_end': jsp_info['line_end'],
                'hash_value': jsp_info['hash_value'],
                'has_error': 'N',
                'error_message': None,
                'del_yn': 'N'
            }
            jsp_data_list.append(jsp_data)
        
        # 배치 저장 (USER RULES: 공통함수 사용)
        if jsp_data_list:
            processed_count = self.db_utils.batch_insert_or_replace('components', jsp_data_list)
            if processed_count > 0:
                info(f"JSP 컴포넌트 저장 완료: {processed_count}개")
                return True
            else:
                handle_error(Exception("JSP 컴포넌트 저장 실패"), "JSP 컴포넌트 저장 실패")
                return False
        else:
            warning("저장할 유효한 JSP 컴포넌트가 없습니다")
            return True
            
    except Exception as e:
        handle_error(e, "JSP 컴포넌트 저장 실패")
        return False
```

### 4.2 JSP 컴포넌트 데이터 구성

**components 테이블 저장 데이터**:
- `project_id`: 프로젝트 ID
- `component_type`: 'JSP'
- `component_name`: JSP 파일명 (예: "userList.jsp")
- `parent_id`: None (JSP는 독립적인 컴포넌트)
- `file_id`: JSP 파일 ID (files 테이블과 연결)
- `line_start`: 시작 라인 번호
- `line_end`: 종료 라인 번호
- `hash_value`: JSP 내용 해시값
- `has_error`: 'N'
- `error_message`: None
- `del_yn`: 'N'

## 5. JSP 컴포넌트 ID 조회

### 5.1 JSP 컴포넌트 ID 조회 로직

```python
def _get_jsp_component_id(self, project_id: int, jsp_name: str) -> Optional[int]:
    """
    JSP명으로 JSP 컴포넌트 ID 조회
    
    Args:
        project_id: 프로젝트 ID
        jsp_name: JSP 파일명
        
    Returns:
        JSP 컴포넌트 ID
    """
    try:
        # USER RULES: 공통함수 사용 지향
        from util import PathUtils
        path_utils = PathUtils()
        
        # JSP 컴포넌트 ID 조회
        jsp_component_id = path_utils.get_jsp_component_id(project_id, jsp_name)
        return jsp_component_id
        
    except Exception as e:
        warning(f"JSP 컴포넌트 ID 조회 실패: {jsp_name}, 오류: {str(e)}")
        return None
```

### 5.2 JSP 컴포넌트 ID 조회 쿼리

```sql
SELECT component_id 
FROM components 
WHERE project_id = ? 
  AND component_type = 'JSP' 
  AND component_name = ? 
  AND del_yn = 'N'
```

## 6. JSP 컴포넌트 추출 예시

### 6.1 JSP 파일 예시

```jsp
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<!DOCTYPE html>
<html>
<head>
    <title>사용자 목록</title>
</head>
<body>
    <h1>사용자 목록</h1>
    
    <%
        List<User> users = userService.getUserList();
        String message = userController.getMessage();
    %>
    
    <c:forEach items="${users}" var="user">
        <div>
            <span>${user.name}</span>
            <span>${user.email}</span>
        </div>
    </c:forEach>
    
    <p><%= message %></p>
</body>
</html>
```

### 6.2 추출된 JSP 컴포넌트 정보

```python
jsp_component = {
    'jsp_name': 'userList.jsp',
    'jsp_path': '/WEB-INF/views/user/userList.jsp',
    'line_start': 1,
    'line_end': 25,
    'hash_value': 'a1b2c3d4e5f6...'
}
```

### 6.3 components 테이블 저장 데이터

```python
jsp_data = {
    'project_id': 1,
    'component_type': 'JSP',
    'component_name': 'userList.jsp',
    'parent_id': None,
    'file_id': 1001,
    'line_start': 1,
    'line_end': 25,
    'hash_value': 'a1b2c3d4e5f6...',
    'has_error': 'N',
    'error_message': None,
    'del_yn': 'N'
}
```

## 7. 오류 처리

### 7.1 JSP 파일 읽기 오류

```python
try:
    jsp_content = file_utils.read_file(jsp_file)
    if not jsp_content:
        return {
            'jsp_component': None,
            'java_method_relationships': [],
            'file_path': jsp_file,
            'has_error': 'Y',
            'error_message': 'JSP 파일 읽기 실패'
        }
except Exception as e:
    # USER RULES: 파싱 에러는 has_error='Y', error_message 남기고 계속 진행
    warning(f"JSP 파일 읽기 실패: {jsp_file}, 오류: {str(e)}")
    return {
        'jsp_component': None,
        'java_method_relationships': [],
        'file_path': jsp_file,
        'has_error': 'Y',
        'error_message': f'JSP 파일 읽기 실패: {str(e)}'
    }
```

### 7.2 JSP 컴포넌트 정보 추출 오류

```python
try:
    jsp_component = self._extract_jsp_component_info(jsp_content, jsp_file)
except Exception as e:
    # USER RULES: 파싱 에러는 has_error='Y', error_message 남기고 계속 진행
    warning(f"JSP 컴포넌트 정보 추출 실패: {jsp_file}, 오류: {str(e)}")
    jsp_component = None
```

### 7.3 데이터베이스 저장 오류

```python
try:
    if self._save_jsp_components_to_database([jsp_component]):
        self.stats['jsp_components_created'] += 1
except Exception as e:
    # 시스템 에러 (데이터베이스, 메모리 등) - 프로그램 종료
    handle_error(e, f"JSP 컴포넌트 저장 실패: {jsp_file}")
    return False
```

## 8. 통계 정보

### 8.1 JSP 컴포넌트 추출 통계

```python
def _print_jsp_loading_statistics(self):
    """JSP 로딩 통계 정보 출력"""
    try:
        info("=== JSP 로딩 통계 ===")
        info(f"처리된 JSP 파일: {self.stats['jsp_files_processed']}개")
        info(f"생성된 JSP 컴포넌트: {self.stats['jsp_components_created']}개")
        info(f"생성된 JSP → METHOD 관계: {self.stats['jsp_method_relationships_created']}개")
        info(f"오류 발생: {self.stats['errors']}개")
        
        if self.stats['errors'] > 0:
            warning(f"JSP 처리 중 {self.stats['errors']}개 오류 발생")
        else:
            info("오류 없이 완료")
            
    except Exception as e:
        handle_error(e, "JSP 로딩 통계 출력 실패")
```

### 8.2 통계 정보 구성

**통계 정보**:
- `jsp_files_processed`: 처리된 JSP 파일 수
- `jsp_components_created`: 생성된 JSP 컴포넌트 수
- `jsp_method_relationships_created`: 생성된 JSP → METHOD 관계 수
- `errors`: 오류 발생 수

## 9. 다음 단계

다음 문서에서는 Java 메서드 호출 분석 로직을 제시합니다:
- [4. Java 메서드 호출 분석](./20250914_022900_5단계개발계획서_04_Java메서드호출분석.md)
