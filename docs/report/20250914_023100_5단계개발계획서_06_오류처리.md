# 6단계 개발계획서 - 오류 처리 및 예외 상황

## 문서 정보
- **작성일**: 2025-09-14 02:31:00
- **작성자**: AI Assistant
- **문서 유형**: 개발계획서
- **대상 단계**: 6단계 - 오류 처리

## 1. 오류 처리 개요

### 1.1 오류 처리 원칙
- **파싱 에러**: `has_error='Y'`, `error_message` 저장 후 계속 진행
- **시스템 에러**: `handle_error()` 공통함수로 exit
- **오류 로깅**: 상세한 오류 메시지와 함께 로그 기록
- **오류 통계**: 오류 발생 수를 통계에 기록

### 1.2 오류 유형 분류
1. **파싱 오류**: JSP 파싱 실패, 잘못된 JSP 구문
2. **분석 오류**: Java 메서드 호출 추출 실패
3. **데이터베이스 오류**: 연결 실패, 쿼리 실행 실패
4. **파일 시스템 오류**: 파일 읽기 실패, 권한 부족
5. **메모리 오류**: 메모리 부족, 메모리 누수

## 2. 파싱 오류 처리

### 2.1 JSP 파일 읽기 오류

```python
def parse_jsp_file(self, jsp_file: str) -> Dict[str, Any]:
    """
    JSP 파일에서 컴포넌트 정보 추출 및 Java 메서드 관계 분석
    
    Args:
        jsp_file: JSP 파일 경로
        
    Returns:
        분석 결과 딕셔너리
    """
    try:
        # 1. JSP 파일 읽기
        file_utils = FileUtils()
        jsp_content = file_utils.read_file(jsp_file)
        if not jsp_content:
            # USER RULES: 파싱 에러는 has_error='Y', error_message 남기고 계속 진행
            return {
                'jsp_component': None,
                'java_method_relationships': [],
                'file_path': jsp_file,
                'has_error': 'Y',
                'error_message': 'JSP 파일 읽기 실패'
            }
        
        # 2. JSP 컴포넌트 정보 추출
        jsp_component = self._extract_jsp_component_info(jsp_content, jsp_file)
        
        # 3. Java 메서드 호출 분석
        java_method_relationships = self._analyze_java_method_calls(jsp_content)
        
        # 4. 통계 업데이트
        self.stats['files_processed'] += 1
        if jsp_component:
            self.stats['jsp_components_extracted'] += 1
        self.stats['java_method_relationships_created'] += len(java_method_relationships)
        
        return {
            'jsp_component': jsp_component,
            'java_method_relationships': java_method_relationships,
            'file_path': jsp_file
        }
        
    except Exception as e:
        # USER RULES: 파싱 에러는 has_error='Y', error_message 남기고 계속 진행
        error_message = f"JSP 파싱 중 예외 발생: {str(e)}"
        warning(f"{error_message} - {jsp_file}")
        self.stats['errors'] += 1
        return {
            'jsp_component': None,
            'java_method_relationships': [],
            'file_path': jsp_file,
            'has_error': 'Y',
            'error_message': error_message
        }
```

### 2.2 JSP 컴포넌트 정보 추출 오류

```python
def _extract_jsp_component_info(self, jsp_content: str, file_path: str) -> Dict[str, Any]:
    """
    JSP 파일에서 JSP 컴포넌트 정보 추출
    
    Args:
        jsp_content: JSP 파일 내용
        file_path: 파일 경로
        
    Returns:
        JSP 컴포넌트 정보
    """
    try:
        # JSP 파일명 추출
        jsp_name = os.path.basename(file_path)
        
        # JSP 경로 추출 (웹 애플리케이션 기준 상대 경로)
        jsp_path = self._extract_jsp_path(file_path)
        
        # 라인 번호 추출
        line_start = 1
        line_end = jsp_content.count('\n') + 1
        
        # 해시 값 생성
        hash_value = HashUtils().generate_md5(jsp_content)
        
        return {
            'jsp_name': jsp_name,
            'jsp_path': jsp_path,
            'line_start': line_start,
            'line_end': line_end,
            'hash_value': hash_value
        }
        
    except Exception as e:
        # USER RULES: 파싱 에러는 has_error='Y', error_message 남기고 계속 진행
        warning(f"JSP 컴포넌트 정보 추출 실패: {str(e)}")
        return None
```

### 2.3 Java 메서드 호출 분석 오류

```python
def _analyze_java_method_calls(self, jsp_content: str) -> List[Dict[str, Any]]:
    """
    JSP 파일에서 Java 메서드 호출 분석
    
    Args:
        jsp_content: JSP 파일 내용
        
    Returns:
        Java 메서드 호출 관계 정보 리스트
    """
    try:
        method_calls = []
        
        # 1. 스크립틀릿 분석
        try:
            scriptlet_method_calls = self._analyze_scriptlets(jsp_content)
            method_calls.extend(scriptlet_method_calls)
        except Exception as e:
            warning(f"스크립틀릿 분석 실패: {str(e)}")
        
        # 2. 표현식 분석
        try:
            expression_method_calls = self._analyze_expressions(jsp_content)
            method_calls.extend(expression_method_calls)
        except Exception as e:
            warning(f"표현식 분석 실패: {str(e)}")
        
        # 3. EL 분석
        try:
            el_method_calls = self._analyze_el_expressions(jsp_content)
            method_calls.extend(el_method_calls)
        except Exception as e:
            warning(f"EL 분석 실패: {str(e)}")
        
        # 4. JSTL 분석
        try:
            jstl_method_calls = self._analyze_jstl_tags(jsp_content)
            method_calls.extend(jstl_method_calls)
        except Exception as e:
            warning(f"JSTL 분석 실패: {str(e)}")
        
        # 5. 중복 제거
        unique_method_calls = self._remove_duplicate_method_calls(method_calls)
        
        return unique_method_calls
        
    except Exception as e:
        # USER RULES: 파싱 에러는 has_error='Y', error_message 남기고 계속 진행
        warning(f"Java 메서드 호출 분석 실패: {str(e)}")
        return []
```

## 3. 시스템 오류 처리

### 3.1 데이터베이스 연결 오류

```python
def execute_jsp_loading(self) -> bool:
    """
    JSP 로딩 실행: 6단계 처리
    
    Returns:
        실행 성공 여부
    """
    try:
        info("=== JSP 로딩 시작: 6단계 처리 ===")
        
        # 데이터베이스 연결 (USER RULES: 공통함수 사용)
        try:
            self.db_utils = DatabaseUtils(self.metadata_db_path)
            if not self.db_utils.connect():
                # 시스템 에러 - 프로그램 종료
                handle_error(Exception("메타데이터베이스 연결 실패"), "데이터베이스 연결 실패")
                return False
        except Exception as e:
            # 시스템 에러 - 프로그램 종료
            handle_error(e, "데이터베이스 연결 실패")
            return False
        
        # 1. JSP 파일 수집
        jsp_files = self.jsp_parser.get_filtered_jsp_files(self.project_source_path)
        if not jsp_files:
            warning("JSP 파일이 없습니다")
            return True
        
        # 2. JSP 파일별 통합 처리 (메모리 최적화)
        for jsp_file in jsp_files:
            try:
                # 6단계 통합 처리: JSP 컴포넌트 추출 + Java 메서드 관계 분석
                analysis_result = self.jsp_parser.parse_jsp_file(jsp_file)
                
                # 파싱 에러 체크 (USER RULES: 파싱 에러는 계속 진행)
                if analysis_result.get('has_error') == 'Y':
                    warning(f"JSP 파싱 에러로 건너뜀: {jsp_file} - {analysis_result.get('error_message', '')}")
                    self.stats['errors'] += 1
                    continue
                
                # JSP 컴포넌트 저장
                if analysis_result['jsp_component']:
                    try:
                        if self._save_jsp_components_to_database([analysis_result['jsp_component']]):
                            self.stats['jsp_components_created'] += 1
                    except Exception as e:
                        # 시스템 에러 - 프로그램 종료
                        handle_error(e, f"JSP 컴포넌트 저장 실패: {jsp_file}")
                        return False
                
                # JSP → METHOD 관계 저장
                if analysis_result['java_method_relationships']:
                    try:
                        if self._save_jsp_method_relationships_to_database(analysis_result['java_method_relationships']):
                            self.stats['jsp_method_relationships_created'] += len(analysis_result['java_method_relationships'])
                    except Exception as e:
                        # 시스템 에러 - 프로그램 종료
                        handle_error(e, f"JSP → METHOD 관계 저장 실패: {jsp_file}")
                        return False
                
                self.stats['jsp_files_processed'] += 1
                
                # 메모리 최적화: 처리 후 즉시 해제
                del analysis_result
                
            except Exception as e:
                # 시스템 에러 (데이터베이스, 메모리 등) - 프로그램 종료
                handle_error(e, f"JSP 파일 처리 실패: {jsp_file}")
                return False
        
        # 3. 통계 정보 출력
        self._print_jsp_loading_statistics()
        
        info("=== JSP 로딩 완료 ===")
        return True
        
    except Exception as e:
        # 시스템 에러 - 프로그램 종료
        handle_error(e, "JSP 로딩 실행 실패")
        return False
    finally:
        # 데이터베이스 연결 해제
        if self.db_utils:
            self.db_utils.disconnect()
```

### 3.2 파일 시스템 오류

```python
def get_filtered_jsp_files(self, project_path: str = None) -> List[str]:
    """
    JSP 파일 수집 및 필터링
    
    Args:
        project_path: 프로젝트 경로
        
    Returns:
        JSP 파일 경로 리스트
    """
    try:
        # USER RULES: 공통함수 사용 지향
        file_utils = FileUtils()
        
        # USER RULES: 하드코딩 지양 - PathUtils 공통함수 사용
        if project_path is None and self.project_name:
            from util import PathUtils
            path_utils = PathUtils()
            project_path = path_utils.get_project_source_path(self.project_name)
        
        if not project_path:
            # 시스템 에러 - 프로그램 종료
            handle_error(Exception("프로젝트 경로가 지정되지 않았습니다"), "JSP 파일 수집 실패")
        
        jsp_files = []
        try:
            for root, dirs, files in os.walk(project_path):
                for file in files:
                    if file.endswith('.jsp'):
                        file_path = os.path.join(root, file)
                        if self._is_valid_jsp_file(file_path):
                            jsp_files.append(file_path)
        except PermissionError as e:
            # 시스템 에러 - 프로그램 종료
            handle_error(e, f"프로젝트 디렉토리 접근 권한 없음: {project_path}")
        except FileNotFoundError as e:
            # 시스템 에러 - 프로그램 종료
            handle_error(e, f"프로젝트 디렉토리를 찾을 수 없음: {project_path}")
        
        info(f"JSP 파일 수집 완료: {len(jsp_files)}개")
        return jsp_files
        
    except Exception as e:
        # 시스템 에러 - 프로그램 종료
        handle_error(e, "JSP 파일 수집 실패")
        return []
```

### 3.3 메모리 오류

```python
def _monitor_memory_usage(self) -> Dict[str, Any]:
    """
    메모리 사용량 모니터링
    
    Returns:
        메모리 사용량 정보
    """
    try:
        import psutil
        import os
        
        # 현재 프로세스 정보
        process = psutil.Process(os.getpid())
        
        # 메모리 사용량 정보
        memory_info = {
            'rss': process.memory_info().rss,  # 물리 메모리 사용량
            'vms': process.memory_info().vms,  # 가상 메모리 사용량
            'percent': process.memory_percent(),  # 메모리 사용률
            'available': psutil.virtual_memory().available,  # 사용 가능한 메모리
            'total': psutil.virtual_memory().total  # 전체 메모리
        }
        
        # 메모리 사용률이 90% 이상이면 시스템 에러
        if memory_info['percent'] > 90:
            handle_error(Exception(f"메모리 사용률이 90%를 초과했습니다: {memory_info['percent']:.1f}%"), "메모리 부족")
        
        return memory_info
        
    except Exception as e:
        warning(f"메모리 사용량 모니터링 실패: {str(e)}")
        return {}
```

## 4. 오류 복구 전략

### 4.1 파싱 오류 복구

```python
def _handle_parsing_error(self, error_message: str, file_path: str) -> Dict[str, Any]:
    """
    파싱 오류 처리
    
    Args:
        error_message: 오류 메시지
        file_path: 파일 경로
        
    Returns:
        오류 정보가 포함된 분석 결과
    """
    try:
        # USER RULES: 파싱 에러는 has_error='Y', error_message 남기고 계속 진행
        warning(f"JSP 파싱 오류: {file_path} - {error_message}")
        self.stats['errors'] += 1
        
        return {
            'jsp_component': None,
            'java_method_relationships': [],
            'file_path': file_path,
            'has_error': 'Y',
            'error_message': error_message
        }
        
    except Exception as e:
        # 시스템 에러 - 프로그램 종료
        handle_error(e, "파싱 오류 처리 실패")
        return {}
```

### 4.2 시스템 오류 복구

```python
def _handle_system_error(self, error: Exception, context: str) -> None:
    """
    시스템 오류 처리
    
    Args:
        error: 예외 객체
        context: 오류 발생 컨텍스트
    """
    try:
        # 시스템 에러 - 프로그램 종료
        handle_error(error, context)
        
    except Exception as e:
        # 최종 오류 처리
        error(f"시스템 오류 처리 실패: {str(e)}")
        sys.exit(1)
```

## 5. 오류 로깅 및 모니터링

### 5.1 오류 로깅

```python
def _log_error(self, error_type: str, error_message: str, file_path: str = None):
    """
    오류 로깅
    
    Args:
        error_type: 오류 타입
        error_message: 오류 메시지
        file_path: 파일 경로 (선택적)
    """
    try:
        if file_path:
            error(f"[{error_type}] {error_message} - 파일: {file_path}")
        else:
            error(f"[{error_type}] {error_message}")
            
    except Exception as e:
        # 로깅 실패 시 콘솔에 출력
        print(f"로깅 실패: {str(e)}")

def _log_warning(self, warning_message: str, file_path: str = None):
    """
    경고 로깅
    
    Args:
        warning_message: 경고 메시지
        file_path: 파일 경로 (선택적)
    """
    try:
        if file_path:
            warning(f"{warning_message} - 파일: {file_path}")
        else:
            warning(warning_message)
            
    except Exception as e:
        # 로깅 실패 시 콘솔에 출력
        print(f"로깅 실패: {str(e)}")
```

### 5.2 오류 통계

```python
def _print_jsp_loading_statistics(self):
    """JSP 로딩 통계 정보 출력"""
    try:
        info("=== JSP 로딩 통계 ===")
        info(f"처리된 JSP 파일: {self.stats['jsp_files_processed']}개")
        info(f"생성된 JSP 컴포넌트: {self.stats['jsp_components_created']}개")
        info(f"생성된 JSP → METHOD 관계: {self.stats['jsp_method_relationships_created']}개")
        info(f"오류 발생: {self.stats['errors']}개")
        
        if self.stats['errors'] > 0:
            warning(f"JSP 처리 중 {self.stats['errors']}개 오류 발생")
            
            # 오류 상세 정보 출력
            error_rate = (self.stats['errors'] / self.stats['jsp_files_processed'] * 100) if self.stats['jsp_files_processed'] > 0 else 0
            warning(f"오류율: {error_rate:.1f}%")
        else:
            info("오류 없이 완료")
            
    except Exception as e:
        handle_error(e, "JSP 로딩 통계 출력 실패")
```

## 6. 오류 처리 예시

### 6.1 JSP 파일 읽기 오류 예시

```python
# JSP 파일이 존재하지 않는 경우
try:
    jsp_content = file_utils.read_file(jsp_file)
    if not jsp_content:
        return {
            'jsp_component': None,
            'java_method_relationships': [],
            'file_path': jsp_file,
            'has_error': 'Y',
            'error_message': 'JSP 파일 읽기 실패'
        }
except FileNotFoundError as e:
    # USER RULES: 파싱 에러는 has_error='Y', error_message 남기고 계속 진행
    warning(f"JSP 파일을 찾을 수 없습니다: {jsp_file}")
    return {
        'jsp_component': None,
        'java_method_relationships': [],
        'file_path': jsp_file,
        'has_error': 'Y',
        'error_message': f'JSP 파일을 찾을 수 없습니다: {str(e)}'
    }
except PermissionError as e:
    # USER RULES: 파싱 에러는 has_error='Y', error_message 남기고 계속 진행
    warning(f"JSP 파일 읽기 권한 없음: {jsp_file}")
    return {
        'jsp_component': None,
        'java_method_relationships': [],
        'file_path': jsp_file,
        'has_error': 'Y',
        'error_message': f'JSP 파일 읽기 권한 없음: {str(e)}'
    }
```

### 6.2 데이터베이스 저장 오류 예시

```python
# JSP 컴포넌트 저장 오류
try:
    if self._save_jsp_components_to_database([jsp_component]):
        self.stats['jsp_components_created'] += 1
except sqlite3.OperationalError as e:
    # 시스템 에러 - 프로그램 종료
    handle_error(e, f"데이터베이스 작업 실패: {jsp_file}")
    return False
except sqlite3.IntegrityError as e:
    # 시스템 에러 - 프로그램 종료
    handle_error(e, f"데이터베이스 무결성 오류: {jsp_file}")
    return False
except Exception as e:
    # 시스템 에러 - 프로그램 종료
    handle_error(e, f"JSP 컴포넌트 저장 실패: {jsp_file}")
    return False
```

### 6.3 메모리 부족 오류 예시

```python
# 메모리 부족 오류
try:
    jsp_content = file_utils.read_file(jsp_file)
    # JSP 내용 처리
except MemoryError as e:
    # 시스템 에러 - 프로그램 종료
    handle_error(e, f"메모리 부족으로 JSP 파일 처리 실패: {jsp_file}")
    return False
except OSError as e:
    if e.errno == 12:  # ENOMEM
        # 시스템 에러 - 프로그램 종료
        handle_error(e, f"메모리 부족으로 JSP 파일 처리 실패: {jsp_file}")
        return False
    else:
        # 시스템 에러 - 프로그램 종료
        handle_error(e, f"시스템 오류로 JSP 파일 처리 실패: {jsp_file}")
        return False
```

## 7. 다음 단계

다음 문서에서는 문서화 완료를 제시합니다:
- [7. 문서화 완료](./20250914_023200_6단계개발계획서_07_문서화완료.md)
