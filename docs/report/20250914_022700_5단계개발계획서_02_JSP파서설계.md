# 6단계 개발계획서 - JSP 파서 설계 및 구현 방안

## 문서 정보
- **작성일**: 2025-09-14 02:27:00
- **작성자**: AI Assistant
- **문서 유형**: 개발계획서
- **대상 단계**: 6단계 - JSP 파서 설계

## 1. JSP 파서 아키텍처 설계

### 1.1 전체 아키텍처

```
JspLoadingEngine (jsp_loading.py)
├── JspParser (parser/jsp_parser.py)
│   ├── JSP 컴포넌트 정보 추출
│   ├── Java 메서드 호출 분석
│   └── 관계 정보 생성
├── DatabaseUtils (util/database_utils.py)
├── FileUtils (util/file_utils.py)
└── ConfigUtils (util/config_utils.py)
```

### 1.2 파일 구조

```
CreateMetaDb/
├── jsp_loading.py              # 6단계 메인 엔진
├── parser/
│   ├── jsp_parser.py           # JSP 파싱 로직
│   ├── xml_parser.py            # 3단계 (기존 유지)
│   └── java_parser.py           # 4단계 (기존 유지)
├── config/parser/
│   └── jsp_keyword.yaml        # JSP 파싱 설정
└── util/                        # 공통 유틸리티 (기존)
```

## 2. JspLoadingEngine 설계

### 2.1 클래스 구조

```python
class JspLoadingEngine:
    """JSP 로딩 엔진 - 6단계 처리"""
    
    def __init__(self, project_name: str):
        """JSP 로딩 엔진 초기화"""
        
    def execute_jsp_loading(self) -> bool:
        """6단계 처리 실행"""
        
    def _save_jsp_components_to_database(self, jsp_components: List[Dict[str, Any]]) -> bool:
        """JSP 컴포넌트를 components 테이블에 저장"""
        
    def _save_jsp_method_relationships_to_database(self, relationships: List[Dict[str, Any]]) -> bool:
        """JSP → METHOD 관계를 relationships 테이블에 저장"""
```

### 2.2 초기화 과정

```python
def __init__(self, project_name: str):
    """
    JSP 로딩 엔진 초기화
    
    Args:
        project_name: 프로젝트명
    """
    self.project_name = project_name
    self.project_source_path = get_project_source_path(project_name)
    self.metadata_db_path = get_project_metadata_db_path(project_name)
    self.db_utils = None
    
    # JSP 파서 초기화 (USER RULES: 공통함수 사용, 전역 프로젝트 정보 활용)
    self.jsp_parser = JspParser()
    
    # 통계 정보
    self.stats = {
        'jsp_files_processed': 0,
        'jsp_components_created': 0,
        'jsp_method_relationships_created': 0,
        'jsp_class_relationships_created': 0,
        'errors': 0
    }
```

### 2.3 메인 실행 로직

```python
def execute_jsp_loading(self) -> bool:
    """
    JSP 로딩 실행: 6단계 처리
    
    Returns:
        실행 성공 여부
    """
    try:
        info("=== JSP 로딩 시작: 6단계 처리 ===")
        
        # 데이터베이스 연결 (USER RULES: 공통함수 사용)
        self.db_utils = DatabaseUtils(self.metadata_db_path)
        if not self.db_utils.connect():
            error("메타데이터베이스 연결 실패")
            return False
        
        # 1. JSP 파일 수집
        jsp_files = self.jsp_parser.get_filtered_jsp_files(self.project_source_path)
        if not jsp_files:
            warning("JSP 파일이 없습니다")
            return True
        
        # 2. JSP 파일별 통합 처리 (메모리 최적화)
        for jsp_file in jsp_files:
            try:
                # 6단계 통합 처리: JSP 컴포넌트 추출 + Java 메서드 관계 분석
                analysis_result = self.jsp_parser.parse_jsp_file(jsp_file)
                
                # 파싱 에러 체크 (USER RULES: 파싱 에러는 계속 진행)
                if analysis_result.get('has_error') == 'Y':
                    warning(f"JSP 파싱 에러로 건너뜀: {jsp_file} - {analysis_result.get('error_message', '')}")
                    self.stats['errors'] += 1
                    continue
                
                if analysis_result['jsp_component']:
                    # JSP 컴포넌트 저장
                    try:
                        if self._save_jsp_components_to_database([analysis_result['jsp_component']]):
                            self.stats['jsp_components_created'] += 1
                    except Exception as e:
                        handle_error(e, f"JSP 컴포넌트 저장 실패: {jsp_file}")
                        return False
                
                if analysis_result['java_method_relationships']:
                    # JSP → METHOD 관계 저장
                    try:
                        if self._save_jsp_method_relationships_to_database(analysis_result['java_method_relationships']):
                            self.stats['jsp_method_relationships_created'] += len(analysis_result['java_method_relationships'])
                    except Exception as e:
                        handle_error(e, f"JSP → METHOD 관계 저장 실패: {jsp_file}")
                        return False
                
                self.stats['jsp_files_processed'] += 1
                
                # 메모리 최적화: 처리 후 즉시 해제
                del analysis_result
                
            except Exception as e:
                # 시스템 에러 (데이터베이스, 메모리 등) - 프로그램 종료
                handle_error(e, f"JSP 파일 처리 실패: {jsp_file}")
                return False
        
        # 3. 통계 정보 출력
        self._print_jsp_loading_statistics()
        
        info("=== JSP 로딩 완료 ===")
        return True
        
    except Exception as e:
        handle_error(e, "JSP 로딩 실행 실패")
        return False
    finally:
        # 데이터베이스 연결 해제
        if self.db_utils:
            self.db_utils.disconnect()
```

## 3. JspParser 설계

### 3.1 클래스 구조

```python
class JspParser:
    """JSP 파서 - 6단계 통합 처리"""
    
    def __init__(self, config_path: str = None, project_name: str = None):
        """JSP 파서 초기화"""
        
    def get_filtered_jsp_files(self, project_path: str = None) -> List[str]:
        """JSP 파일 수집 및 필터링"""
        
    def parse_jsp_file(self, jsp_file: str) -> Dict[str, Any]:
        """JSP 파일에서 컴포넌트 정보 추출 및 Java 메서드 관계 분석"""
        
    def _extract_jsp_component_info(self, jsp_content: str, file_path: str) -> Dict[str, Any]:
        """JSP 파일에서 JSP 컴포넌트 정보 추출"""
        
    def _analyze_java_method_calls(self, jsp_content: str) -> List[Dict[str, Any]]:
        """JSP 파일에서 Java 메서드 호출 분석"""
```

### 3.2 초기화 과정

```python
def __init__(self, config_path: str = None, project_name: str = None):
    """
    JSP 파서 초기화
    
    Args:
        config_path: 설정 파일 경로
        project_name: 프로젝트명 (선택적, 전역에서 가져옴)
    """
    # USER RULES: 하드코딩 지양 - 프로젝트 정보 전역 관리
    from util.global_project import get_global_project_name, get_global_project_id, is_global_project_info_set
    
    # 전역 프로젝트 정보 활용 (실행 중 변경되지 않는 값)
    if is_global_project_info_set():
        self.project_name = get_global_project_name()
        self.project_id = get_global_project_id()
    else:
        # 개별 설정이 있는 경우 (테스트 등)
        self.project_name = project_name
        self.project_id = None
    
    if config_path is None:
        # USER RULES: 하드코딩 지양 - 설정 파일 경로
        jsp_config_path = "config/parser/jsp_keyword.yaml"
        self.config = self._load_config(jsp_config_path)
    else:
        self.config_path = config_path
        self.config = self._load_config()
    
    self.stats = {
        'files_processed': 0,
        'files_skipped': 0,
        'jsp_components_extracted': 0,
        'java_method_relationships_created': 0,
        'errors': 0
    }
```

### 3.3 JSP 파일 수집

```python
def get_filtered_jsp_files(self, project_path: str = None) -> List[str]:
    """
    JSP 파일 수집 및 필터링
    
    Args:
        project_path: 프로젝트 경로
        
    Returns:
        JSP 파일 경로 리스트
    """
    try:
        # USER RULES: 공통함수 사용 지향
        file_utils = FileUtils()
        
        # USER RULES: 하드코딩 지양 - PathUtils 공통함수 사용
        if project_path is None and self.project_name:
            from util import PathUtils
            path_utils = PathUtils()
            project_path = path_utils.get_project_source_path(self.project_name)
        
        if not project_path:
            # USER RULES: Exception 발생시 handle_error()로 exit()
            handle_error(Exception("프로젝트 경로가 지정되지 않았습니다"), "JSP 파일 수집 실패")
        
        jsp_files = []
        for root, dirs, files in os.walk(project_path):
            for file in files:
                if file.endswith('.jsp'):
                    file_path = os.path.join(root, file)
                    if self._is_valid_jsp_file(file_path):
                        jsp_files.append(file_path)
        
        info(f"JSP 파일 수집 완료: {len(jsp_files)}개")
        return jsp_files
        
    except Exception as e:
        # USER RULES: Exception 발생시 handle_error()로 exit()
        handle_error(e, "JSP 파일 수집 실패")
        return []

def _is_valid_jsp_file(self, file_path: str) -> bool:
    """
    유효한 JSP 파일인지 확인
    
    Args:
        file_path: 파일 경로
        
    Returns:
        유효성 여부
    """
    try:
        file_utils = FileUtils()
        content = file_utils.read_file(file_path)
        if not content:
            return False
        
        # 기본적인 JSP 파일 검증
        jsp_indicators = ['<%@', '<%', '<%=', '<jsp:', '<c:', '<fmt:', '<sql:', '<x:']
        content_lower = content.lower()
        return any(indicator in content_lower for indicator in jsp_indicators)
        
    except Exception as e:
        warning(f"JSP 파일 확인 실패: {file_path}, 오류: {str(e)}")
        return False
```

### 3.4 통합 분석 메서드

```python
def parse_jsp_file(self, jsp_file: str) -> Dict[str, Any]:
    """
    JSP 파일에서 컴포넌트 정보 추출 및 Java 메서드 관계 분석
    
    Args:
        jsp_file: JSP 파일 경로
        
    Returns:
        분석 결과 딕셔너리
    """
    try:
        # 1. JSP 파일 읽기
        file_utils = FileUtils()
        jsp_content = file_utils.read_file(jsp_file)
        if not jsp_content:
            return {
                'jsp_component': None,
                'java_method_relationships': [],
                'file_path': jsp_file,
                'has_error': 'Y',
                'error_message': 'JSP 파일 읽기 실패'
            }
        
        # 2. JSP 컴포넌트 정보 추출
        jsp_component = self._extract_jsp_component_info(jsp_content, jsp_file)
        
        # 3. Java 메서드 호출 분석
        java_method_relationships = self._analyze_java_method_calls(jsp_content)
        
        # 4. 통계 업데이트
        self.stats['files_processed'] += 1
        if jsp_component:
            self.stats['jsp_components_extracted'] += 1
        self.stats['java_method_relationships_created'] += len(java_method_relationships)
        
        return {
            'jsp_component': jsp_component,
            'java_method_relationships': java_method_relationships,
            'file_path': jsp_file
        }
        
    except Exception as e:
        # USER RULES: 파싱 에러는 has_error='Y', error_message 남기고 계속 진행
        error_message = f"JSP 파싱 중 예외 발생: {str(e)}"
        warning(f"{error_message} - {jsp_file}")
        self.stats['errors'] += 1
        return {
            'jsp_component': None,
            'java_method_relationships': [],
            'file_path': jsp_file,
            'has_error': 'Y',
            'error_message': error_message
        }
```

## 4. 설정 파일 활용

### 4.1 jsp_keyword.yaml 활용

```python
def _load_config(self, config_path: str = None) -> Dict[str, Any]:
    """
    설정 파일 로드
    
    Args:
        config_path: 설정 파일 경로
        
    Returns:
        설정 딕셔너리
    """
    try:
        # USER RULES: 공통함수 사용 지향
        config_utils = ConfigUtils()
        path = config_path or self.config_path
        config = config_utils.load_yaml_config(path)
        if not config:
            # USER RULES: Exception 발생시 handle_error()로 exit()
            handle_error(Exception(f"설정 파일을 로드할 수 없습니다: {path}"), "설정 파일 로드 실패")
            return self._get_default_config()
        return config
    except Exception as e:
        # USER RULES: Exception 발생시 handle_error()로 exit()
        handle_error(e, f"설정 파일 로드 실패: {config_path or self.config_path}")
        return self._get_default_config()

def _get_default_config(self) -> Dict[str, Any]:
    """기본 설정 반환"""
    return {
        'jsp_scriptlet_patterns': [
            r'<%([^%]+)%>',  # 스크립틀릿
        ],
        'jsp_expression_patterns': [
            r'<%=([^%]+)%>',  # 표현식
        ],
        'jsp_el_patterns': [
            r'\$\{([^}]+)\}',  # EL 표현식
        ],
        'jsp_jstl_patterns': [
            r'<c:([^>]+)>',  # JSTL Core
            r'<fmt:([^>]+)>',  # JSTL Formatting
            r'<sql:([^>]+)>',  # JSTL SQL
        ],
        'java_method_call_patterns': [
            r'(\w+)\.(\w+)\s*\(',  # object.method()
            r'(\w+)\s*\(',  # method()
        ]
    }
```

### 4.2 설정 파일 기반 패턴 매칭

```python
def _extract_jsp_component_info(self, jsp_content: str, file_path: str) -> Dict[str, Any]:
    """
    JSP 파일에서 JSP 컴포넌트 정보 추출
    
    Args:
        jsp_content: JSP 파일 내용
        file_path: 파일 경로
        
    Returns:
        JSP 컴포넌트 정보
    """
    try:
        # JSP 파일명 추출
        jsp_name = os.path.basename(file_path)
        
        # JSP 경로 추출 (웹 애플리케이션 기준 상대 경로)
        jsp_path = self._extract_jsp_path(file_path)
        
        # 라인 번호 추출
        line_start = 1
        line_end = jsp_content.count('\n') + 1
        
        # 해시 값 생성
        hash_value = HashUtils().generate_md5(jsp_content)
        
        return {
            'jsp_name': jsp_name,
            'jsp_path': jsp_path,
            'line_start': line_start,
            'line_end': line_end,
            'hash_value': hash_value
        }
        
    except Exception as e:
        # USER RULES: 파싱 에러는 has_error='Y', error_message 남기고 계속 진행
        warning(f"JSP 컴포넌트 정보 추출 실패: {str(e)}")
        return None

def _extract_jsp_path(self, file_path: str) -> str:
    """
    JSP 파일 경로에서 웹 애플리케이션 기준 상대 경로 추출
    
    Args:
        file_path: JSP 파일 경로
        
    Returns:
        웹 애플리케이션 기준 상대 경로
    """
    try:
        # 프로젝트 소스 경로에서 상대 경로 추출
        if self.project_name:
            from util import PathUtils
            path_utils = PathUtils()
            project_source_path = path_utils.get_project_source_path(self.project_name)
            
            if file_path.startswith(project_source_path):
                relative_path = os.path.relpath(file_path, project_source_path)
                # Windows 경로를 Unix 경로로 변환
                return '/' + relative_path.replace('\\', '/')
        
        # 기본값: 파일명만 반환
        return '/' + os.path.basename(file_path)
        
    except Exception as e:
        warning(f"JSP 경로 추출 실패: {str(e)}")
        return '/' + os.path.basename(file_path)
```

## 5. 데이터베이스 저장 로직

### 5.1 JSP 컴포넌트 저장

```python
def _save_jsp_components_to_database(self, jsp_components: List[Dict[str, Any]]) -> bool:
    """
    JSP 컴포넌트를 components 테이블에 저장
    
    Args:
        jsp_components: JSP 컴포넌트 정보 리스트
        
    Returns:
        저장 성공 여부
    """
    try:
        if not jsp_components:
            warning("저장할 JSP 컴포넌트가 없습니다")
            return True
        
        # 프로젝트 ID 조회 (USER RULES: 공통함수 사용)
        project_id = self._get_project_id()
        if not project_id:
            handle_error(Exception("프로젝트 ID를 찾을 수 없습니다"), "JSP 컴포넌트 저장 실패")
            return False
        
        # JSP 데이터 변환
        jsp_data_list = []
        for jsp_info in jsp_components:
            # 파일 ID 조회
            file_id = self._get_file_id(jsp_info['file_path'])
            if not file_id:
                warning(f"파일 ID를 찾을 수 없습니다: {jsp_info['file_path']}")
                continue
            
            jsp_data = {
                'project_id': project_id,
                'component_type': 'JSP',
                'component_name': jsp_info['jsp_name'],
                'parent_id': None,  # JSP는 독립적인 컴포넌트
                'file_id': file_id,
                'line_start': jsp_info['line_start'],
                'line_end': jsp_info['line_end'],
                'hash_value': jsp_info['hash_value'],
                'has_error': 'N',
                'error_message': None,
                'del_yn': 'N'
            }
            jsp_data_list.append(jsp_data)
        
        # 배치 저장 (USER RULES: 공통함수 사용)
        if jsp_data_list:
            processed_count = self.db_utils.batch_insert_or_replace('components', jsp_data_list)
            if processed_count > 0:
                info(f"JSP 컴포넌트 저장 완료: {processed_count}개")
                return True
            else:
                handle_error(Exception("JSP 컴포넌트 저장 실패"), "JSP 컴포넌트 저장 실패")
                return False
        else:
            warning("저장할 유효한 JSP 컴포넌트가 없습니다")
            return True
            
    except Exception as e:
        handle_error(e, "JSP 컴포넌트 저장 실패")
        return False
```

### 5.2 JSP → METHOD 관계 저장

```python
def _save_jsp_method_relationships_to_database(self, relationships: List[Dict[str, Any]]) -> bool:
    """
    JSP → METHOD 관계를 relationships 테이블에 저장
    
    Args:
        relationships: JSP → METHOD 관계 정보 리스트
        
    Returns:
        저장 성공 여부
    """
    try:
        if not relationships:
            warning("저장할 JSP → METHOD 관계가 없습니다")
            return True
        
        # 프로젝트 ID 조회 (USER RULES: 공통함수 사용)
        project_id = self._get_project_id()
        if not project_id:
            handle_error(Exception("프로젝트 ID를 찾을 수 없습니다"), "JSP → METHOD 관계 저장 실패")
            return False
        
        # 관계 데이터 변환
        relationship_data_list = []
        for rel_info in relationships:
            # JSP 컴포넌트 ID 조회
            jsp_component_id = self._get_jsp_component_id(project_id, rel_info['jsp_name'])
            if not jsp_component_id:
                warning(f"JSP 컴포넌트 ID를 찾을 수 없습니다: {rel_info['jsp_name']}")
                continue
            
            # METHOD 컴포넌트 ID 조회
            method_component_id = self._get_method_component_id(
                project_id, rel_info['class_name'], rel_info['method_name']
            )
            if not method_component_id:
                warning(f"METHOD 컴포넌트 ID를 찾을 수 없습니다: {rel_info['class_name']}.{rel_info['method_name']}")
                continue
            
            relationship_data = {
                'src_id': jsp_component_id,
                'dst_id': method_component_id,
                'rel_type': 'CALL_METHOD',
                'confidence': 1.0,
                'has_error': 'N',
                'error_message': None,
                'hash_value': '-',  # USER RULES: 하드코딩된 '-'
                'del_yn': 'N'
            }
            relationship_data_list.append(relationship_data)
        
        # 배치 저장 (USER RULES: 공통함수 사용)
        if relationship_data_list:
            processed_count = self.db_utils.batch_insert_or_replace('relationships', relationship_data_list)
            if processed_count > 0:
                info(f"JSP → METHOD 관계 저장 완료: {processed_count}개")
                return True
            else:
                handle_error(Exception("JSP → METHOD 관계 저장 실패"), "JSP → METHOD 관계 저장 실패")
                return False
        else:
            warning("저장할 유효한 JSP → METHOD 관계가 없습니다")
            return True
            
    except Exception as e:
        handle_error(e, "JSP → METHOD 관계 저장 실패")
        return False
```

## 6. 다음 단계

다음 문서에서는 구체적인 JSP 컴포넌트 추출 로직을 제시합니다:
- [3. JSP 컴포넌트 추출 로직](./20250914_022800_6단계개발계획서_03_JSP컴포넌트추출.md)
