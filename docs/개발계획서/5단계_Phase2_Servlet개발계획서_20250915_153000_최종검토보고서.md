# 5단계 Phase2 Servlet 진입점 분석 - 최종 검토 보고서

## 1. 최종 결론

**Servlet 진입점 분석 개발 계획은 제안된 개선안들을 모두 반영하는 조건으로 개발을 승인합니다.**

기존 Phase 1(Spring)의 성공적인 아키텍처를 계승하면서도, Servlet의 고유한 특성(`web.xml` 설정, 클래스 상속 구조)을 반영한 개선안들이 통합되어야만 분석의 정확성과 완성도를 보장할 수 있습니다.

이 문서는 최종적으로 합의된 **핵심 개선안**과 **구현 가이드**를 제시하며, 개발팀은 이 보고서의 명세를 기준으로 실제 개발을 진행해야 합니다.

---

## 2. 종합 검토 의견

### 2.1. 잘된 점 (Strengths)
- **아키텍처 재활용**: Phase 1에서 검증된 전략 패턴, 캐싱, 2단계 필터링 아키텍처를 그대로 사용하여 개발 효율성과 시스템의 일관성을 높였습니다.
- **상세한 설정 파일**: `servlet_entry_keyword.yaml`에 Servlet의 다양한 특성(어노테이션, 상속, 메서드명 매핑 등)을 상세하게 정의하여 파서의 유연성을 확보했습니다.
- **Fallback 전략 계승**: `AST -> 정규식`으로 이어지는 Fallback 전략을 통해 파싱의 안정성과 커버리지를 높였습니다.

### 2.2. 보완 필요 사항 (Areas for Improvement)
- **Servlet 특수성 반영 강화**: 초기 계획은 `web.xml`과 클래스 상속 구조에 대한 고려가 부족했습니다. 개발자 의견에서 제안된 **`web.xml` 우선 분석** 및 **4단계 상속 정보 활용**은 필수적으로 반영되어야 합니다.
- **분석 정확도 향상**: `doGet`과 같은 메서드 분석 시, 이름뿐만 아니라 파라미터 시그니처까지 검증하여 분석의 정확도를 높일 필요가 있습니다.

---

## 3. 핵심 개선안 및 최종 구현 가이드

### 3.1. `web.xml` 우선 분석 및 상속 관계 통합 (필수 구현)

**문제점**: `@WebServlet`이 없는 레거시 서블릿과, 부모 클래스에 `doGet`/`doPost`가 정의된 서블릿을 분석하지 못합니다.

**최종 구현 가이드**:
1.  **`BackendEntryLoadingEngine`의 역할 확장**: 엔진 초기화 단계에서 `web.xml`을 **먼저 파싱**하여 `{'클래스 FQDN': 'URL 패턴'}` 형태의 `servlet_url_map`을 생성합니다.
2.  **분석기에 정보 전달**: 생성된 `servlet_url_map`을 `ServletEntryAnalyzer` 생성 시 파라미터로 전달합니다.
3.  **`ServletEntryAnalyzer`의 상속 관계 분석**:
    - `doXXX` 또는 `service` 메서드를 찾을 때, 현재 클래스에 해당 메서드가 없으면 **DB에 질의**하여 4단계에서 분석된 부모 클래스 정보를 가져옵니다.
    - 부모 클래스가 존재하면, 해당 부모 클래스의 파일 내용을 읽어 메서드를 재귀적으로 탐색합니다.
    - 이 로직은 자식 클래스가 메서드를 오버라이드(Override)하는 경우까지 정확하게 처리할 수 있어야 합니다.

**소스 코드 예시**:

**`BackendEntryLoadingEngine` - `web.xml` 파싱:**
```python
# backend_entry_loading.py
import xml.etree.ElementTree as ET

class BackendEntryLoadingEngine:
    def __init__(self, project_name: str):
        # ...
        self.servlet_url_map = self._parse_web_xml()
        # ...
        # 생성된 맵을 포함하여 분석기 로드
        self.analyzers = self._load_analyzers_from_config()

    def _parse_web_xml(self) -> dict:
        """프로젝트의 모든 web.xml을 파싱하여 서블릿 클래스와 URL 패턴 맵을 생성한다."""
        web_xml_files = self.db.get_files_by_name('web.xml')
        url_map = {}
        if not web_xml_files:
            return url_map

        # ... (이전 의견과 동일한 web.xml 파싱 로직) ...
        # servlet-mapping과 servlet 태그를 조합하여 url_map 생성
        return url_map

    def _load_analyzers_from_config(self):
        # ...
        for framework in frameworks_to_load:
            if framework == 'servlet':
                # Servlet 분석기에는 web.xml 파싱 결과를 반드시 전달
                analyzer = self.analyzer_factory.create_analyzer('servlet', servlet_url_map=self.servlet_url_map)
            # ...
```

**`ServletEntryAnalyzer` - 재귀적 메서드 탐색:**
```python
# parser/servlet_entry_analyzer.py
class ServletEntryAnalyzer(BaseEntryAnalyzer):
    # ...
    def _find_http_methods_recursively(self, class_name: str, visited=None) -> dict:
        """DB의 상속 정보를 이용해 부모 클래스까지 재귀적으로 탐색하여 doXXX/service 메서드를 찾는다."""
        if visited is None: visited = set()
        if class_name in visited: return {}
        visited.add(class_name)

        # 1. 현재 클래스의 파일 정보 및 내용 가져오기
        current_file = self.db.get_file_by_class_name(class_name)
        if not current_file: return {}
        
        # 2. 현재 파일 내용에서 메서드 찾기 (AST 또는 정규식)
        found_methods = self._find_methods_in_content(current_file.content)

        # 3. DB에서 부모 클래스 정보 조회 (4단계 분석 결과 활용)
        parent_class_name = self.db.get_parent_class(class_name)
        
        if parent_class_name:
            parent_methods = self._find_http_methods_recursively(parent_class_name, visited)
            # 부모 메서드를 먼저 넣고, 자식 메서드로 덮어쓰기 (오버라이딩 효과)
            parent_methods.update(found_methods)
            return parent_methods
        
        return found_methods
```

### 3.2. `doXXX` 메서드 시그니처 검증 강화 (신규 제안)

**문제점**: `doGet()`이라는 이름의 다른 목적을 가진 메서드(예: 테스트용 목 객체)를 서블릿 진입점으로 오인할 수 있습니다.

**최종 구현 가이드**:
- AST 파싱 단계에서 `doGet`, `doPost` 등의 메서드를 찾을 때, 해당 메서드의 파라미터가 `(HttpServletRequest, HttpServletResponse)` 시그니처와 일치하는지 검증하는 로직을 추가합니다.
- 시그니처가 일치하지 않으면, 이름이 같더라도 진입점으로 간주하지 않아 분석의 정확도를 높입니다.

**소스 코드 예시**:

**`ServletEntryAnalyzer` - AST 파싱 시 파라미터 검증:**
```python
# parser/servlet_entry_analyzer.py
import javalang

class ServletEntryAnalyzer(BaseEntryAnalyzer):
    # ...
    def _parse_with_ast(self, content: str) -> List[Dict]:
        # ...
        for path, node in tree.filter(javalang.tree.MethodDeclaration):
            method_name = node.name
            # 메서드 이름이 'doGet', 'doPost' 등인지 확인
            if method_name in self.config['http_method_mapping']['method_name_mapping']:
                # 파라미터 시그니처 검증
                if self._is_valid_servlet_method_signature(node.parameters):
                    # 시그니처가 유효하면 진입점으로 처리
                    # ...
    
    def _is_valid_servlet_method_signature(self, parameters: list) -> bool:
        """메서드 파라미터가 (HttpServletRequest, HttpServletResponse)인지 검증"""
        if len(parameters) != 2:
            return False
        
        req_param = parameters[0]
        res_param = parameters[1]

        # 파라미터 타입의 이름이 일치하는지 확인
        if (isinstance(req_param.type, javalang.tree.ReferenceType) and
            req_param.type.name == 'HttpServletRequest' and
            isinstance(res_param.type, javalang.tree.ReferenceType) and
            res_param.type.name == 'HttpServletResponse'):
            return True
            
        return False
```

### 3.3. `service()` 메서드 및 확장자 매핑 처리 명세화 (기존 의견 반영)

**문제점**: `service()` 메서드나 `*.do` 같은 확장자 매핑에 대한 처리 규칙이 없으면 분석 결과의 일관성이 떨어집니다.

**최종 구현 가이드**:
- `servlet_entry_keyword.yaml`에 `service_method_http_methods`와 `extension_mapping_prefix` 설정을 **반드시 포함**합니다.
- `ServletEntryAnalyzer`는 이 설정을 기반으로 `service()` 메서드를 여러 HTTP 메서드에 매핑하고, `*.do`와 같은 패턴을 `API_ENTRY.ANY_EXT_PATTERN_DO`와 같이 표준화된 이름으로 변환합니다.

---

## 4. 최종 개발 Task 요약

1.  **[Config]** `servlet_entry_keyword.yaml`에 `service_method_http_methods`, `extension_mapping_prefix` 등 최종 명세를 반영하여 작성합니다.
2.  **[Core]** `BackendEntryLoadingEngine`에 `web.xml` 파싱 로직을 **초기화 단계에 구현**합니다.
3.  **[Factory]** `EntryAnalyzerFactory`가 `ServletEntryAnalyzer` 생성 시 `servlet_url_map`을 전달하도록 수정합니다.
4.  **[Parser]** `ServletEntryAnalyzer`에 `_is_valid_servlet_method_signature`와 같은 **시그니처 검증 로직을 추가**하여 분석 정확도를 높입니다.
5.  **[Parser]** `ServletEntryAnalyzer`에 **DB를 조회하여 상속 관계를 재귀적으로 탐색**하는 `_find_http_methods_recursively` 메서드를 구현합니다.
6.  **[Parser]** `web.xml` 맵, 어노테이션, 상속 관계 탐색 결과를 모두 종합하여 최종 진입점 정보를 생성하도록 `analyze_backend_entry` 메서드를 완성합니다.
7.  **[Test]** 상속, `web.xml` 매핑, 잘못된 시그니처 등 다양한 엣지 케이스에 대한 단위 테스트 및 통합 테스트를 작성하여 안정성을 검증합니다.

---

## 5. 결론 및 승인

상기된 **핵심 개선안 3가지(`web.xml` 및 상속 통합, 시그니처 검증, 설정 명세화)**를 모두 반영하는 것을 조건으로, Servlet 진입점 분석 기능의 개발을 **최종 승인**합니다. 이 보고서는 Phase 2 개발의 공식적인 가이드라인 역할을 합니다.