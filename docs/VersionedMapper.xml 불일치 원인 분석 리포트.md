# VersionedMapper.xml 불일치 원인 분석 리포트

## 1. 분석 개요

- **분석 대상**: CreateMetaDb/projects/SampleSrc/src/main/resources/mybatis/mapper/VersionedMapper.xml
- **분석 일시**: 2025년 9월 18일
- **문제 현상**: 기준 문서에서는 6개 쿼리로 기록되었으나, 메타데이터 DB에서는 0개 쿼리로 파싱됨
- **분석 목적**: 파싱 실패 원인 규명 및 해결 방안 제시

## 2. 조사 결과

### 2.1 파일 상태 확인

| 항목 | 상태 | 상세 내용 |
|------|------|-----------|
| 파일 존재 여부 | ✅ 정상 | 파일이 정상적으로 존재함 |
| 파일 크기 | ✅ 정상 | 3,613 bytes |
| 메타DB 등록 | ✅ 정상 | file_id: 64로 등록됨 |
| 컴포넌트 파싱 | ❌ 실패 | SQL 컴포넌트 0개 파싱됨 |

### 2.2 실제 파일 내용

VersionedMapper.xml 파일에는 다음 6개의 SQL 쿼리가 포함되어 있음:

1. `selectUsersV1` (SELECT)
2. `selectUsersV2` (SELECT) 
3. `selectProductsV1` (SELECT)
4. `selectProductsV2` (SELECT)
5. `selectOrdersV1` (SELECT)
6. `selectOrdersV2` (SELECT) ⭐ **문제 쿼리**

## 3. 파싱 실패 원인 분석

### 3.1 XML 구문 오류

**에러 메시지**: `not well-formed (invalid token): line 112, column 30`

**문제 위치**: 
```xml
<select id="selectOrdersV2" resultType="map">
    <!-- ... 기본 SQL ... -->
    <if test="dateTo != null and dateTo != ''">
        AND o.order_date <= #{dateTo}  <!-- ⭐ 에러 발생 지점 -->
    </if>
    <!-- ... -->
</select>
```

### 3.2 구체적 문제점

1. **XML 특수 문자 처리 미흡**
   - `<=` 연산자가 XML에서 올바르게 이스케이프되지 않음
   - XML 파서가 `<` 문자를 태그 시작으로 인식하여 파싱 오류 발생

2. **동적 SQL 태그 복합 사용**
   - MyBatis 동적 SQL 태그(`<if>`) 내부에 특수 문자 포함
   - 복잡한 중첩 구조로 인한 파싱 복잡도 증가

### 3.3 다른 파일과의 비교

| 파일명 | 동적 SQL 사용 | 특수 문자 | 파싱 결과 |
|--------|---------------|-----------|-----------|
| UserMapper.xml | 있음 | 정상 처리 | ✅ 성공 (21개) |
| ProductMapper.xml | 있음 | 정상 처리 | ✅ 성공 (9개) |
| **VersionedMapper.xml** | **있음** | **`<=` 에러** | **❌ 실패 (0개)** |
| MixedErrorMapper.xml | 있음 | 정상 처리 | ✅ 성공 (12개) |

## 4. 에러 처리 방식 분석

### 4.1 현재 파서의 에러 처리 특성

조사 결과, **파일 하나에서 XML 파싱 에러가 발생하면 해당 파일의 모든 쿼리가 메타DB에 생성되지 않음**을 확인했습니다.

#### 에러 처리 방식별 결과:

1. **XML 파싱 에러 (VersionedMapper.xml)**
   - 파일 등록: ✅ 성공 (file_id: 64)
   - 컴포넌트 추출: ❌ 완전 실패 (0개)
   - **원인**: XML 구문 오류로 인한 전체 파일 파싱 불가

2. **부분 쿼리 에러 (MixedErrorMapper.xml)**
   - 파일 등록: ✅ 성공
   - 컴포넌트 추출: ✅ 부분 성공 (12개)
   - **원인**: 개별 쿼리 레벨의 논리적 에러 (존재하지 않는 테이블/컬럼 참조)

### 4.2 에러 처리 레벨별 차이

| 에러 레벨 | 에러 유형 | 파일 등록 | 쿼리 추출 | 예시 |
|-----------|-----------|-----------|-----------|------|
| **XML 레벨** | XML 구문 오류 | ✅ | ❌ 전체 실패 | VersionedMapper.xml |
| **쿼리 레벨** | SQL 논리 오류 | ✅ | ✅ 부분 성공 | MixedErrorMapper.xml |

## 5. 기술적 분석

### 5.1 XML 파싱 에러 상세

```
XML 파싱 에러: not well-formed (invalid token): line 112, column 30
에러 라인: AND o.order_date <= #{dateTo}
                            ^
                            30번째 컬럼
```

### 5.2 파서 처리 순서

1. **파일 스캔**: 파일 존재 확인 및 메타DB 등록 ✅
2. **XML 파싱**: ElementTree로 XML 구조 파싱 ❌ **여기서 실패**
3. **컴포넌트 추출**: SQL 태그별 쿼리 추출 (실행되지 않음)
4. **메타데이터 저장**: 추출된 정보 DB 저장 (저장할 데이터 없음)

### 5.3 MyBatis 동적 SQL 태그 영향

- **정상 케이스**: `<if test="status != null and status != ''">`
- **에러 케이스**: `<if>` 태그 내부의 `<=` 연산자
- **파서 한계**: XML 파서가 동적 SQL 내 특수 문자를 적절히 처리하지 못함

## 6. 해결 방안

### 6.1 즉시 해결 방안

#### 방안 1: XML 이스케이프 처리
```xml
<!-- 변경 전 (에러 발생) -->
<if test="dateTo != null and dateTo != ''">
    AND o.order_date <= #{dateTo}
</if>

<!-- 변경 후 (수정됨) -->
<if test="dateTo != null and dateTo != ''">
    AND o.order_date &lt;= #{dateTo}
</if>
```

#### 방안 2: CDATA 섹션 사용
```xml
<if test="dateTo != null and dateTo != ''">
    <![CDATA[
    AND o.order_date <= #{dateTo}
    ]]>
</if>
```

### 6.2 근본적 해결 방안

#### 파서 개선
1. **에러 복구 기능**: XML 파싱 에러 발생 시에도 부분적 정보 수집
2. **전처리 단계**: XML 파싱 전에 특수 문자 이스케이프 처리
3. **로그 강화**: 파싱 실패 시 상세한 에러 정보 기록

#### 검증 프로세스 추가
1. **XML 유효성 검사**: 메타데이터 생성 전 XML 구문 검증
2. **부분 파싱 지원**: 일부 쿼리 파싱 실패 시에도 나머지 쿼리는 처리
3. **에러 리포트**: 파싱 실패한 파일과 원인을 별도 리포트로 생성

## 7. 핵심 발견사항

### 7.1 에러 전파 방식

**중요**: 파일 하나에서 has_error가 발생하는 경우의 처리 방식이 에러 유형에 따라 다름:

1. **XML 구문 오류**: 파일 전체의 모든 쿼리가 메타DB에 생성되지 않음
2. **SQL 논리 오류**: 해당 쿼리만 에러 처리되고 나머지 쿼리는 정상 생성됨

### 7.2 영향도 분석

- **메타데이터 완성도**: 6개 쿼리 누락으로 약 8% 감소
- **콜체인 분석**: VersionedController, VersionedService 관련 연계 정보 누락
- **테이블 관계**: users, orders, order_items, categories 테이블 관계 정보 부족

## 8. 권장사항

### 8.1 단기 조치 (즉시 적용)

1. **VersionedMapper.xml 수정**: 
   - `<=` → `&lt;=` 변경
   - XML 유효성 검증 후 메타데이터 재생성

2. **유사 파일 점검**:
   - 다른 XML 파일에서도 동일한 문제 확인
   - 일괄 수정 스크립트 작성

### 8.2 중기 개선 (1-2주 내)

1. **파서 로직 개선**:
   - XML 파싱 에러 시 부분 복구 기능 추가
   - 상세 에러 로그 및 리포트 생성

2. **검증 프로세스 구축**:
   - 메타데이터 생성 전 XML 유효성 자동 검사
   - 파싱 실패 파일 목록 및 원인 자동 리포트

### 8.3 장기 개선 (1개월 내)

1. **강건한 파서 개발**:
   - 다양한 XML 구문 오류에 대한 복구 능력 강화
   - MyBatis 동적 SQL 태그 전용 파서 개발

2. **품질 관리 체계**:
   - 파싱 성공률 모니터링
   - 정기적인 메타데이터 품질 검증

## 9. 결론

VersionedMapper.xml의 파싱 실패는 **XML 특수 문자(`<=`) 처리 미흡**으로 인한 구문 오류가 주요 원인입니다. 

**핵심 발견**: XML 파싱 레벨의 에러는 파일 전체의 모든 쿼리 추출을 차단하지만, 개별 쿼리 레벨의 논리적 에러는 해당 쿼리만 영향을 주고 나머지는 정상 처리됩니다.

이는 MyBatis 동적 SQL 태그 내부에서 발생하는 전형적인 XML 파싱 문제로, 적절한 이스케이프 처리나 CDATA 섹션 사용으로 해결 가능합니다.

단순한 파일 수정으로 즉시 해결할 수 있는 문제이지만, 향후 유사한 문제를 방지하기 위해서는 파서 개선과 검증 프로세스 구축이 필요합니다.

---

**분석 완료일**: 2025년 9월 18일  
**분석자**: AI Assistant  
**다음 조치**: VersionedMapper.xml 파일 수정 및 메타데이터 재생성 권장
