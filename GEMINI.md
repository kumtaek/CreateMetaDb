# SourceAnalyzer 개발지침

## 개요

SourceAnalyzer 시스템을 동적 프로젝트 분석이 가능하도록 개선하여, 하드코딩된 경로와 프로젝트명을 제거하고 명령행 파라미터로 프로젝트를 지정할 수 있도록 하는 요구사항입니다.

- **프로젝트 Root 폴더**: D:\Analyzer\CreateMetaDb

## 1. 필독 문서

- `./docs/*.md` - 모든 설계 및 구현 문서 참조 필수

### 2.3 메타생성 실행 스크립트

```bash
cd CreateMetaDb && python main.py --project-name {project_name} > ./temp/meta_generation_{project_name}.log 2>&1
```

## 4. 동적 경로 구조 및 파일 관리

### 4.1 동적 프로젝트 폴더 구조

```
./projects/{project_name}/
├── src/                    # 분석할 소스코드
│   ├── main/java/         # Java 소스
│   └── main/resources/    # MyBatis XML 등
│   └── (하위 폴더 구조는 프로젝트마다 상이함)
├── db_schema/             # 분석할 DB 스키마 정보
│   ├── ALL_TABLES.csv     # 테이블 정보
│   ├── ALL_TAB_COLUMNS.csv # 컬럼 정보
├── config/                # 프로젝트별 설정 (선택사항)
│   └── target_source_config.yaml
├── metadata.db            # 메타데이터베이스
├── SqlContent.db          # SQL Content 데이터베이스
└── report/                # 생성된 리포트
    ├── *.html
    ├── css/           # Offline환경 실행용 css 파일
    └── js/            # Offline환경 실행용 js 파일
```

### 4.2 폴더 구조 변경 금지

- 현재 폴더 파일 구조를 바꾸지 말 것
- `improved`, `enhanced`, `new` 붙여서 새로운 파일 만들 때는 꼭 허락받기

### 4.3 임시 파일 관리

- 테스트용, 임시용도의 파일은 `./temp`에 저장
- `./temp` 파일 내용은 신뢰하지 않고 참고하지 않음
- 언제든 삭제 가능한 임시용도로 사용
- 한 폴더에 많은 파일 존재 시 성능 저하 → 파일 타입별로 하위 폴더 생성하여 관리

### 4.4 제외 대상

- 영향평가 또는 검토요청에서 기본적으로 `./temp`와 `./projects`는 항상 제외

## 5. 동적 프로젝트 처리 및 메타데이터 전략

### 5.1 프로젝트 처리 원칙

- `--project-name {project_name}` 파라미터로 프로젝트명 입력
- `./projects/{project_name}/src`에서 소스 분석
- `./projects/{project_name}/db_schema`에서 CSV로 테이블/컬럼 정보 로드
- CSV에 포린키/조인 정보가 불완전할 수 있으므로 쿼리 분석으로 JOIN 관계 도출
- 메타DB에 relationships 정보 저장 후 ERD 생성 시 활용

### 5.2 메타데이터 저장 전략

- **메타DB에 저장**: 테이블명, 컬럼명, 관계, JOIN 정보 (구조적 정보만)
- **파일에서 동적 로드**: 소스코드 내용, 쿼리 내용 (필요시에만)
- **중복 제거**: 메타정보는 중복 없이 생성
- **동적 로직**: `./projects/{project_name}` 폴더 하위 파일들로 동적 분석

### 5.3 분석 프로세스

1. **CSV 로드**: `db_schema/*.csv`에서 테이블/컬럼 정보
2. **소스 분석**: `src/` 하위 JSP, JSX, Spring, Java, MyBatis XML 분석 (하위폴더 구조는 동적)
3. **JOIN 추출**: 쿼리에서 JOIN 관계 도출
   - CSV에 PK/FK가 불완전할 수 있음
   - `db_tables`에 미존재 테이블 발견 시 등록
   - owner 미정 시 `UNKNOWN` 값 사용
4. **메타DB 저장**: 중복 없는 구조적 정보만 저장
5. **리포트 생성**: `./projects/{project_name}/report/` 폴더에 출력

## 6. 개발 및 구현 규칙

### 6.1 공통 함수 활용

- 공통함수가 있는 기능을 추가 개발하지 말 것 (꼭 승인 후 추가 개발)
- 공통함수나 기존에 구현된 기능이 존재하는지 확인 후 활용
- 하드코딩 지양, 공통 경로 유틸리티 함수 사용
- 파일 및 디렉토리 경로 작업 시 프로젝트의 공통 경로 유틸리티 함수 사용

### 6.2 파서 개발 참고사항

- `D:\Analyzer\CreateMetaDb\parser\manual` 참고
- `D:\Analyzer\CreateMetaDb\config\parser`의 키워드, 패턴 정의 설정파일 참고
- 하드코딩 지양할 것

### 6.3 에러 처리 규칙

- **모든 exception 발생 시** `handle_error()`로 `exit()` 해야 에러 인지 가능
- 파싱 중 소스에 오류가 있는 경우 스킵하는 것처럼 의미가 있는 경우를 제외하고는 모든 오류 발생 시 에러로그 남기고 **중단**되어야 함
- 에러 발생 시 warn 찍고 계속 진행하면 중요한 에러도 놓치게 되니, 꼭 `handle_error()`로 exit 처리

**잘못된 사례:**

```python
try:
    # 파싱 로직
    return await parser.parse(content, file_path)  # 여기서 에러 발생
except Exception as e:
    logger.error(f"파일 분석 중 오류 발생 {file_path}: {e}")  # 에러 로그만 찍고
    return None  # None 반환하고 다음 파일로 넘어감 # 계속 진행 --> 이러면 안됨!!!
```

### 6.4 하드코딩 금지 규칙 (절대 금지!!!)

- **절대 금지**: `SampleSrc`에 특화된 로직 개발 금지
- **절대 금지**: 프로젝트명, 경로 등으로 하드코딩 금지. 개발,테스트용 샘플소스인 SampleSrc/ 내의 정보로 하드코딩 금지
- `--project-name {project_name}` 파라미터를 받아서 동적으로 구현
- `./projects/{project_name}/src`에서 소스파일, `./projects/{project_name}/db_schema`에서 DB스키마 정보(csv) 수집
- 하위 폴더 구조나 파일은 프로젝트마다 상이하므로 동적 로직으로 구현
- **상대경로 사용**: 절대경로 사용 금지, 운영환경 배포 시 경로 변경 고려
  (개발 - WIndows, 운영 - RHEL, Root경로가 다를 수 있음)

### 6.5 프로젝트별 설정

- 프로젝트 hash_value는 상수 '-'로 하드코딩
- 동일한 쿼리 ID 또는 Class, Method가 다른 파일에 중복 가능하다
- Oracle이 주사용 DB이다. Oracle 11g 위주로 SQL 파싱로직 개발하면 됨

### 6.6 기존 소스 활용 규칙

- 기 개발된 소스를 분석해서 관련 로직이 있는 경우 새로 개발할 로직과 연계하여 통합
- 무조건 신규 메소드, 함수 생성을 해서 죽은 소스를 만들지 말 것

### 6.7 파일 생성 규칙

- **시각화 리포트, 분석 리포트**: `./projects/{project_name}/report/` 하위에 생성일시 포함하여 저장

### 6.8 개발 환경 규칙

- **오프라인 환경**: 오프라인 폐쇄망에서 동작 가능하도록 구현
- 크로스플랫폼 고려. 개발 - WIndows, 운영 - RHEL, Root경로가 달라질 수 있음.
- **라이선스**: 기업 내 무료 사용 가능한 라이선스만 사용

## 7. 문서 및 보고서 작성

### 7.1 문서 작성 경로

- `./docs/report` 폴더에 `{timestamp}_{문서제목}.md` 파일로 작성
- md 문서 작성 또는 보고해줘 라는 요청에 기본적으로 ./docs/report 경로에 파일 생성 할 것

### 7.2 질의 파일 작성법

- `qna/` 폴더에 `Q_{timestamp}_{질의제목}.md` 파일로 질의서 작성
- 답변은 `A*.md`로 작성

### 7.3 진척 보고

- '진척보고 해줘' 요청 시: `./docs/report/진척보고_{timestamp}_{진척주요내용제목}.md` 파일로 작성
- timestamp상 직전 보고 이후 수행한 내용으로 보고

### 7.4 보고서 작성

- 'OOO 보고서 작성해줘' 요청 시: `./docs/report/{timestamp}_{보고서제목}.md`로 작성

## 8. 기술적 제약사항

### 8.1 이모지 사용 금지

- 인코딩 문제로 에러 발생
- 이모지 대신 단순 기호 사용

### 8.2 Mermaid 코드 작성 시 주의사항

# ?? Mermaid 에러 조치방법

## 개요

본 문서는 Mermaid 다이어그램 작성 시 발생하는 오류들과 해결방법을 정리한 가이드입니다. 실제 개발 환경에서 발생한 문제들을 바탕으로 작성되었습니다.

## Mermaid Invalid Codes 체크리스트

### 1. HTML 태그 오인식

**문제**: `<User>` 같은 표기는 HTML 태그로 인식됨 → 에러 발생

**해결**: `&lt;User&gt;` 로 변환

```mermaid
# ? 잘못된 예
A[<User> 정보] --> B[처리]

# ? 올바른 예  
A[&lt;User&gt; 정보] --> B[처리]
```

### 2. 줄바꿈 처리 (환경별 대응)

#### 기본 원칙 (표준 Mermaid):
- **노드 라벨 안** ([], {}, ()) → `\n` 은 줄바꿈으로 동작
- **노드 라벨 밖** (예: style, 일반 텍스트) → `\n` 그대로 출력
- ? **권장**: 라벨 안 줄바꿈은 `\n` 사용

#### 환경별 예외 처리:
- **MarkText, 구버전 Mermaid**: `\n`이 동작하지 않는 경우 발생
- **복잡한 라벨**: 한글 + 숫자 + 특수문자 조합 시 `\n` 실패 가능
- **HTML 태그 혼재**: 다른 HTML 태그와 함께 사용 시 충돌

#### 해결 방법 우선순위:

```mermaid
# 1순위: 표준 방법 (권장)
A["첫 번째 줄\n두 번째 줄"]

# 2순위: \n 동작 안 할 때
A["첫 번째 줄<br/>두 번째 줄"]

# 3순위: 복잡한 경우
A["복잡한 내용<br/>특수문자 &lt;tag&gt;<br/>여러 줄"]
```

**실제 적용 예시**:
```mermaid
# ? 동작하지 않는 경우
JSP["JSP Pages\n12개 파일"]

# ? 해결된 경우
JSP["JSP Pages<br/>12개 파일"]
```

### 3. 긴 라벨 / 특수문자

**문제**: 라벨이 길거나 `{}`, `<`, `>` 같은 특수문자가 포함되면 파싱 오류 위험 ↑

**해결**: 라벨을 `[" ... "]` 로 감싸기

```mermaid
# ? 위험한 예
A[UserController{복잡한내용}] --> B

# ? 안전한 예
A["UserController{복잡한내용}"] --> B
```

### 4. 이모지 사용

**문제**: 일부 이모지(?, ?, ??)는 파서에서 깨짐

**해결**: "?", "?" 같은 단순 기호 사용

```mermaid
# ? 문제 발생 가능
A[처리 완료 ?] --> B[다음 단계 ??]

# ? 안전한 방법
A[처리 완료 ?] --> B[다음 단계 →]
```

### 5. 중복 정의

**문제**: 
- 같은 edge(예: A --> B)를 두 번 선언 → 오류
- 같은 style을 두 번 선언 → 경고/혼란

**해결**: 중복 제거

```mermaid
# ? 중복 정의
A --> B
A --> B  # 중복!
style A fill:#red
style A fill:#blue  # 중복!

# ? 중복 제거
A --> B
style A fill:#red
```

### 6. ERD(erDiagram) 제약

**문제**: 
- PK/FK, 제약조건, 인덱스 → 지원 안 됨
- 복잡한 속성 정의 → 파싱 오류

**지원되는 형식**:
- 속성 정의: `string name`, `int age` 같은 단순 형식만 지원
- 관계 정의: `A ||--o{ B : has` 형태만 지원

**해결**: 단순 문법만 사용

```mermaid
# ? 지원되는 ERD 문법
erDiagram
    USER {
        string name
        int age
        string email
    }
    ORDER {
        int order_id
        string status
    }
    USER ||--o{ ORDER : has
```

### 7. 초기화 블록(init)

**문제**: JSON은 큰따옴표만 허용

```mermaid
# ? 작은따옴표 사용
%%{init: {'theme':'default'}}%%

# ? 큰따옴표 사용
%%{init: {"theme":"default"}}%%
```

### 8. 화살표 기호

**문제**: 유니코드 화살표 `→`는 지원되지 않음

**해결**: `->` 사용

```mermaid
# ? 유니코드 화살표
A → B

# ? ASCII 화살표
A -> B
```

## 환경별 대응 가이드

### MarkText 사용 시
- `\n` 대신 `<br/>` 태그 우선 사용
- 복잡한 한글 라벨은 반드시 큰따옴표로 감싸기
- 특수문자 포함 시 HTML 엔티티 사용

### VS Code + Mermaid Extension
- 표준 `\n` 문법 정상 동작
- 실시간 미리보기에서 오류 확인 가능

### GitHub/GitLab
- 표준 Mermaid 문법 지원
- 이모지 지원 제한적

## 디버깅 방법

### 1. 단계별 축소
복잡한 다이어그램에서 오류 발생 시:
1. 노드 하나씩 제거하면서 테스트
2. 오류 발생 지점 특정
3. 해당 부분만 수정

### 2. 브라우저 개발자 도구 활용
- F12 → Console 탭에서 Mermaid 오류 메시지 확인
- 구체적인 파싱 오류 위치 파악 가능

### 3. 온라인 Mermaid 에디터 활용
- https://mermaid.live/ 에서 테스트
- 실시간으로 오류 확인 및 수정

## 최종 요약

### ? 안전한 작성법
1. HTML 태그: `&lt;tag&gt;` 사용
2. 줄바꿈: `\n` 우선, 안되면 `<br/>` 사용  
3. 긴 라벨: `"내용"` 큰따옴표로 감싸기
4. 이모지: 단순 기호 사용 (`?`, `?`)
5. 중복: 관계/스타일 중복 제거
6. ERD: 단순 문법만 사용 (PK/FK 불가)
7. init: 큰따옴표 JSON (`{"theme":"default"}`)
8. 화살표: `->` 사용 (유니코드 `→` 금지)

### ?? 문제 해결 순서
1. **기본 문법 확인**: 표준 Mermaid 문법 준수
2. **환경 확인**: 사용 중인 뷰어/에디터 특성 파악
3. **단계적 수정**: 복잡한 부분부터 단순화
4. **테스트**: 온라인 에디터에서 검증
5. **적용**: 실제 환경에 반영




## 9. 참고 문서

- `D:\Analyzer\CreateMetaDb\docs\*.md` - 각종 설계문서 참조



