# 쿼리 분석기 개발 문서

## 1. 문제 상황

### 1.1 현재 문제점
- `isValidOrder` 메소드에서 `status`가 쿼리로 인식됨
- 실제 SQL 패턴이 아닌 단순 문자열이 테이블로 인식됨

### 1.2 원인 분석
```java
// isValidOrder 메소드
protected boolean isValidOrder(Map<String, Object> orderData) {
    BigDecimal amount = (BigDecimal) orderData.get("totalAmount");
    String status = (String) orderData.get("status");
    return amount != null && amount.compareTo(BigDecimal.ZERO) > 0 && 
           List.of("PENDING", "CONFIRMED", "SHIPPED").contains(status);
}
```

Java 문법을 제거하면:
```
totalAmount
status
PENDING
CONFIRMED
SHIPPED
```

이것들이 테이블로 인식되는 문제 발생.

## 2. 해결 방안

### 2.1 3단계 절차로 처리

#### 1단계: 자바, JPA, XML에서 쿼리만 잘라내기
- 자바 문법, XML 마이바티스 문법, JPA 문법을 제거
- 문자열만 추려냄

#### 2단계: 설계된 패턴에서 테이블 추출
다음 패턴에만 매칭하여 테이블 추출:
```
SELECT * FROM ...
SELECT * FROM ... WHERE
SELECT * FROM ... (

UPDATE ... SET

DELETE FROM ...
DELETE FROM ... WHERE

INSERT INTO ... (
INSERT INTO ... SELECT

MERGE INTO ... USING

JOIN ... ON
```

#### 3단계: 조인관계 도출
- 조인관계뿐만 아니라 컬럼이 도출됨
- COLUMNS, COMPONENTS에 컬럼정보가 없으면 인퍼드로 등록

### 2.2 파일 타입별 SQL 추출

#### 자바에서 SQL 추출
**변수 컨케터네이션 누적 처리:**
```java
String query1 = "SELECT * FROM";
String query2 = "INSERT INTO ORDERS";
query1 = query1 + " WHERE status = 'ACTIVE'";
query1 += " AND id > 0";
```

**지원하는 패턴:**
- `String query = "SELECT * FROM";`
- `query = query + " WHERE";`
- `query += " WHERE";`
- `StringBuffer sb = new StringBuffer("INSERT INTO");`
- `sb.append(" USERS");`

**SQL 키워드 필터링:**
- `SELECT`, `INSERT`, `UPDATE`, `DELETE`, `MERGE`가 포함된 변수만 추출
- 주석 제거 후 SQL 키워드로 시작하는지 확인

#### XML에서 SQL 추출
**XML 태그 제거:**
```xml
<select id="getUserList">
    SELECT * FROM USERS WHERE status = 'ACTIVE'
</select>
```
→ `SELECT * FROM USERS WHERE status = 'ACTIVE'`

#### JPA에서 SQL 추출
**@Query 어노테이션에서 추출:**
```java
@Query("SELECT u FROM User u WHERE u.status = 'ACTIVE'")
```
→ `SELECT u FROM User u WHERE u.status = 'ACTIVE'`

**파라미터 처리:**
- `:name` 파라미터는 그대로 유지 (의미 파악을 위해)

### 2.3 설계된 패턴에서 테이블 추출

#### FROM 패턴 (3가지)
1. `SELECT * FROM T1` (끝)
2. `SELECT * FROM T1 WHERE`
3. `SELECT * FROM T1 (`

#### 다른 패턴들
- `UPDATE ... SET` → UPDATE 뒤에 테이블명
- `INSERT INTO ...` → INTO 뒤에 테이블명
- `DELETE FROM ...` → FROM 뒤에 테이블명 (FROM 패턴과 동일)
- `MERGE INTO ... USING` → INTO와 USING 사이에 테이블명
- `JOIN ... ON` → JOIN 뒤에 테이블명

### 2.4 테이블 알리아스 처리
```sql
SELECT u.*, d.name
FROM USERS u
LEFT JOIN DEPARTMENTS d ON u.dept_id = d.id
```
- `u` → `USERS`
- `d` → `DEPARTMENTS`

### 2.5 조인관계 파싱

#### 명시적 JOIN
```sql
JOIN table alias ON alias1.column1 = alias2.column2
```

#### Implicit JOIN
```sql
FROM table1, table2 WHERE table1.column1 = table2.column2
```

## 3. 핵심 원칙

### 3.1 SQL 패턴 매칭 원칙
- **실제 SQL 구문만** 인식
- **설계된 패턴에만** 매칭
- **키워드와 문자열 리터럴** 구분

### 3.2 테이블 추출 원칙
- **FROM 뒤에만** 집중
- **INTO 뒤에만** 집중 (INSERT)
- **UPDATE부터 SET까지만** 집중
- **INTO와 USING 사이만** 집중 (MERGE)

### 3.3 컨텍스트 고려
- **실제 SQL 구문의 컨텍스트** 고려
- **단순 문자열 리터럴** 제외
- **변수 컨케터네이션** 누적 처리

## 4. 예상 결과

### 4.1 개선 전
```
status
PENDING
CONFIRMED
SHIPPED
```
→ 테이블로 잘못 인식

### 4.2 개선 후
```
SELECT * FROM USERS WHERE status = 'ACTIVE'
```
→ USERS 테이블만 정확히 추출

## 5. 개발 순서

1. **1단계**: 자바, XML, JPA에서 SQL 추출 함수 구현
2. **2단계**: 설계된 패턴에서 테이블 추출 함수 구현
3. **3단계**: 조인관계 및 컬럼 정보 도출 함수 구현
4. **4단계**: 메인 함수 수정 및 통합
5. **5단계**: 테스트 및 검증

## 6. 주의사항

- **파일 타입별** 개별 구현 필요
- **공통 처리**는 쿼리 도출 후
- **오탐 최소화** 우선